[
    {
        "id": "vlm_tab",
        "type": "tab",
        "label": "è§†è§‰è¯­è¨€æ¨¡å‹ (VLM)",
        "disabled": false,
        "info": "# è§†è§‰è¯­è¨€æ¨¡å‹ (Vision Language Model)\n\n## åŠŸèƒ½ä»‹ç»\n\næœ¬ç« èŠ‚ä»‹ç»å¦‚ä½•åœ¨RDKå¹³å°ä½“éªŒç«¯ä¾§ Vision Language Model (VLM)ã€‚å¾—ç›Šäºä¹¦ç”Ÿå¤§æ¨¡å‹ã€SmolVLMçš„ä¼˜ç§€æˆæœï¼Œæˆ‘ä»¬åœ¨RDKå¹³å°ä¸Šå®ç°äº†é‡åŒ–ä¸éƒ¨ç½²ã€‚åŒæ—¶ï¼Œæœ¬ç¤ºä¾‹åŸºäº llama.cpp ä¸­ KV Cache çš„å¼ºå¤§ç®¡ç†èƒ½åŠ›ï¼Œç»“åˆ RDK å¹³å° BPU æ¨¡å—çš„è®¡ç®—ä¼˜åŠ¿ï¼Œå®ç°äº†æœ¬åœ° VLM æ¨¡å‹éƒ¨ç½²ã€‚\n\n## âš ï¸ é‡è¦ï¼šIONå†…å­˜é…ç½®ï¼ˆå¿…é¡»ï¼ï¼‰\n\n**è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼** å¦‚æœä¸é…ç½®IONå†…å­˜ï¼Œæ¨¡å‹100%ä¼šå› ä¸ºå†…å­˜ä¸è¶³å´©æºƒï¼ˆOOM Killedï¼‰ã€‚\n\n### é…ç½®æ­¥éª¤ï¼š\n\n1. **è¿è¡Œé…ç½®å·¥å…·ï¼š**\n   ```bash\n   sudo srpi-config\n   ```\n\n2. **è®¾ç½®IONå†…å­˜ï¼š**\n   - é€‰æ‹©ï¼š`Performance Options` â†’ `ION Memory`\n   - é€‰æ‹©ï¼š**`320MB+640MB+640MB`** (å³ 1.6GB)\n   - ç¡®è®¤ä¿å­˜\n\n3. **é‡å¯ç”Ÿæ•ˆï¼š**\n   ```bash\n   sudo reboot\n   ```\n   **å¿…é¡»é‡å¯ï¼** é…ç½®æ‰ä¼šç”Ÿæ•ˆã€‚\n\n4. **ï¼ˆå¯é€‰ï¼‰ä¼˜åŒ–CPUæ€§èƒ½ï¼š**\n   é‡å¯åå¯ä»¥è®¾ç½®CPUé«˜æ€§èƒ½æ¨¡å¼ï¼Œé¿å…æ¨ç†å¡é¡¿ï¼š\n   ```bash\n   sudo bash -c 'echo performance >/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor'\n   ```\n\n### éªŒè¯é…ç½®ï¼š\né‡å¯åå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯IONå†…å­˜é…ç½®ï¼š\n```bash\ncat /proc/device-tree/reserved-memory/*/compatible\n```\n\n## ä½¿ç”¨æ¨¡å¼\n\n### ğŸ“· æ‹ç…§æ¨¡å¼\n1. é€‰æ‹©æ¨¡å‹ç±»å‹ï¼ˆInternVL æˆ– SmolVLMï¼‰\n2. ç‚¹å‡»\"ğŸ“· USBæ‘„åƒå¤´æ‹ç…§\"æŒ‰é’®\n3. ç³»ç»Ÿä¼šè‡ªåŠ¨å¯¹ç…§ç‰‡è¿›è¡ŒVLMæ¨ç†\n4. æ¨ç†ç»“æœï¼ˆæ–‡æœ¬æè¿°ï¼‰ä¼šæ˜¾ç¤ºåœ¨Node-REDç¼–è¾‘å™¨ä¸­\n\n### ğŸ–¼ï¸ å›çŒæ¨¡å¼\n1. é€‰æ‹©æ¨¡å‹ç±»å‹ï¼ˆInternVL æˆ– SmolVLMï¼‰\n2. ç‚¹å‡»\"å¯åŠ¨æœ¬åœ°å›¾ç‰‡VLMæ¨ç†\"æŒ‰é’®\n3. ç³»ç»Ÿä¼šå¯¹æŒ‡å®šå›¾ç‰‡è¿›è¡Œæ¨ç†\n4. æ¨ç†ç»“æœï¼ˆæ–‡æœ¬æè¿°ï¼‰ä¼šæ˜¾ç¤ºåœ¨Node-REDç¼–è¾‘å™¨ä¸­\n\n## æ”¯æŒå¹³å°\n\n- RDK X5, RDK X5 Module\n- RDK S100, RDK S100P\n\n## æ”¯æŒæ¨¡å‹\n\n### InternVL2_5 / InternVL3\n- å‚æ•°é‡ï¼š1B / 2B\n- å›¾åƒç¼–ç æ¨¡å‹ï¼švit_model_int16_*.bin (X5) / vit_model_int16_*.hbm (S100)\n- æ–‡æœ¬ç¼–è§£ç æ¨¡å‹ï¼šQwen2.5-0.5B-Instruct-Q4_0.gguf / qwen2_5_*.gguf\n\n### SmolVLM2\n- å‚æ•°é‡ï¼š256M / 500M\n- å›¾åƒç¼–ç æ¨¡å‹ï¼šSigLip_int16_SmolVLM2_*.bin (X5) / SigLip_int16_SmolVLM2_*.hbm (S100)\n- æ–‡æœ¬ç¼–è§£ç æ¨¡å‹ï¼šSmolVLM2-*-Video-Instruct-Q8_0.gguf\n\n## ç®—æ³•ä¿¡æ¯\n\n| æ¨¡å‹ | å‚æ•°é‡ | é‡åŒ–æ–¹å¼ | å¹³å° | è¾“å…¥å°ºå¯¸ | image encoder time(ms) | prefill eval time(ms/token) | eval time(ms/token) |\n|------|--------|---------|------|---------|----------------------|---------------------------|---------------------|\n| InternVL2_5 | 0.5B | Q4_0 | X5 | 1x3x448x448 | 2456.00 | 7.7 | 51.6 |\n| InternVL3 | 0.5B | Q8_0 | S100 | 1x3x448x448 | 100.00 | 9.19 | 41.65 |\n| Smolvlm2 | 256M | Q8_0 | X5 | 1x3x512x512 | 1053 | 9.3 | 27.8 |\n\n## ğŸ“‹ ä½¿ç”¨å‰å¿…è¯»\n\n> âš ï¸ **é‡è¦æç¤º**ï¼šä½¿ç”¨æœ¬åŠŸèƒ½å‰ï¼Œè¯·åŠ¡å¿…å…ˆé…ç½®å¼€å‘æ¿ï¼\n> \n> å»ºè®®å‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œè¯¦ç»†é…ç½®ï¼š\n> \n> ğŸ”— [hobot_llamacpp å®˜æ–¹æ–‡æ¡£](https://developer.d-robotics.cc/rdk_doc/rdk_s/Robot_development/boxs/generate/hobot_llamacpp)\n> \n> é…ç½®å®Œæˆåï¼Œè¯·æŒ‰ç…§ä¸‹æ–¹æ­¥éª¤è¿›è¡ŒIONå†…å­˜é…ç½®ã€‚\n\n## å‡†å¤‡å·¥ä½œ\n\n1. âœ… **é…ç½®IONå†…å­˜**ï¼ˆè§ä¸Šæ–¹é‡è¦æç¤ºï¼‰\n2. RDKå·²çƒ§å½•å¥½Ubuntu 22.04ç³»ç»Ÿé•œåƒ\n3. RDKå·²æˆåŠŸå®‰è£…TogetheROS.Bot\n4. ä¸‹è½½å®‰è£…åŠŸèƒ½åŒ…ï¼š`sudo apt install tros-humble-hobot-llamacpp`\n5. æ¨¡å‹æ–‡ä»¶ä¼šè‡ªåŠ¨ä¸‹è½½åˆ° `$HOME/vlm_model` ç›®å½•ï¼ˆå®‰è£…æ—¶è‡ªåŠ¨å®Œæˆï¼‰\n\n## æ¨¡å‹æ–‡ä»¶ä½ç½®\n\n- **æ¨¡å‹ç›®å½•ï¼š** `$HOME/vlm_model/`ï¼ˆæŒä¹…åŒ–ç›®å½•ï¼Œé‡å¯åä¸ä¼šä¸¢å¤±ï¼‰\n- **å›¾åƒç¼–ç æ¨¡å‹ï¼š** æ ¹æ®å¹³å°è‡ªåŠ¨ä¸‹è½½ï¼ˆX5: `vit_model_int16_v2.bin`, S100: `vit_model_int16.hbm`ï¼‰\n- **æ–‡æœ¬ç¼–è§£ç æ¨¡å‹ï¼š** `Qwen2.5-0.5B-Instruct-Q4_0.gguf` (InternVL) æˆ– `SmolVLM2-256M-Video-Instruct-Q8_0.gguf` (SmolVLM)\n\n## ç»“æœè·å–æ–¹å¼\n\n### æ–¹å¼Aï¼šROS2 Topicè®¢é˜…ï¼ˆæ¨èï¼‰\n\nVLMæ¨ç†å®Œæˆåï¼Œç»“æœä¼šå‘å¸ƒåˆ°ROS2 Topicï¼š\n- **Topicåç§°ï¼š** `/tts_text`\n- **æ¶ˆæ¯ç±»å‹ï¼š** `std_msgs/msg/String`\n- **å†…å®¹ï¼š** æ¨ç†ç»“æœæ–‡æœ¬ï¼ˆå¦‚\"è¿™å¼ å›¾ç‰‡å±•ç¤ºäº†ä¸€åªå¤§ç†ŠçŒ«...\"ï¼‰\n\nå½“å‰æµç¨‹å·²è‡ªåŠ¨è®¢é˜…è¯¥Topicå¹¶è§£æç»“æœã€‚\n\n### æ–¹å¼Bï¼šä»å‘½ä»¤è¾“å‡ºè§£æï¼ˆå¤‡é€‰ï¼‰\n\nå¦‚æœTopicè®¢é˜…å¤±è´¥ï¼Œæµç¨‹ä¼šè‡ªåŠ¨ä»å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºä¸­è§£æç»“æœã€‚\n\n## æ³¨æ„äº‹é¡¹\n\n- âš ï¸ **å¿…é¡»é…ç½®IONå†…å­˜**ï¼ˆ1.6GBï¼‰ï¼Œå¦åˆ™ä¼šå› å†…å­˜ä¸è¶³å´©æºƒ\n- æ¨ç†è¿‡ç¨‹éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆå¯èƒ½éœ€è¦10-30ç§’ï¼‰ï¼Œè¯·è€å¿ƒç­‰å¾…å®Œæ•´è¾“å‡º\n- VLMè¾“å‡ºæ˜¯æµå¼çš„ï¼Œç»“æœä¼šé€æ­¥æ˜¾ç¤ºï¼Œè¯·ç­‰å¾…æ¨ç†å®Œæˆ\n- æ¨¡å‹æ–‡ä»¶ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿ROS2å‘½ä»¤èƒ½æ­£ç¡®æ‰¾åˆ°\n- å¦‚æœåªçœ‹åˆ°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯´æ˜æ¨ç†è¿˜åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç»§ç»­ç­‰å¾…\n- æ¨¡å‹æ–‡ä»¶ä¿å­˜åœ¨ `$HOME/vlm_model`ï¼Œé‡å¯åä¸ä¼šä¸¢å¤±",
        "env": []
    },
    {
        "id": "comment_before_start",
        "type": "comment",
        "z": "vlm_tab",
        "name": "âš ï¸ ä½¿ç”¨å‰å¿…è¯»",
        "info": "**é‡è¦æç¤º**ï¼šä½¿ç”¨æœ¬åŠŸèƒ½å‰ï¼Œè¯·åŠ¡å¿…å…ˆé…ç½®å¼€å‘æ¿ï¼\n\nå»ºè®®å‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œè¯¦ç»†é…ç½®ï¼š\nğŸ”— https://developer.d-robotics.cc/rdk_doc/rdk_s/Robot_development/boxs/generate/hobot_llamacpp\n\né…ç½®å®Œæˆåï¼Œè¯·ç¡®ä¿å·²å®ŒæˆIONå†…å­˜é…ç½®ï¼ˆè§ä¸Šæ–¹Tabè¯´æ˜ï¼‰ã€‚",
        "x": 150,
        "y": 20,
        "wires": []
    },
    {
        "id": "comment_model_selection",
        "type": "comment",
        "z": "vlm_tab",
        "name": "ğŸ”§ æ¨¡å‹é€‰æ‹©",
        "info": "é€‰æ‹©è¦ä½¿ç”¨çš„VLMæ¨¡å‹ç±»å‹",
        "x": 150,
        "y": 60,
        "wires": []
    },
    {
        "id": "inject_set_internvl",
        "type": "inject",
        "z": "vlm_tab",
        "name": "é€‰æ‹© InternVL",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "internvl",
        "payloadType": "str",
        "x": 140,
        "y": 120,
        "wires": [
            [
                "function_save_model_type"
            ]
        ]
    },
    {
        "id": "inject_set_smolvlm",
        "type": "inject",
        "z": "vlm_tab",
        "name": "é€‰æ‹© SmolVLM",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "smolvlm",
        "payloadType": "str",
        "x": 140,
        "y": 160,
        "wires": [
            [
                "function_save_model_type"
            ]
        ]
    },
    {
        "id": "function_save_model_type",
        "type": "function",
        "z": "vlm_tab",
        "name": "ä¿å­˜æ¨¡å‹ç±»å‹",
        "func": "// ä¿å­˜æ¨¡å‹ç±»å‹åˆ°å…¨å±€å˜é‡\n// æ”¹è¿›ï¼šæ·»åŠ å¹³å°æ£€æµ‹é€»è¾‘ï¼Œç»Ÿä¸€åœ¨JSä¸­å¤„ç†\nconst modelType = msg.payload || 'internvl';\nif (typeof global.vlmModelType === 'undefined') {\n    global.vlmModelType = {};\n}\nglobal.vlmModelType.current = modelType;\n\n// æ£€æµ‹å¹³å°ï¼ˆç»Ÿä¸€åœ¨JSä¸­å¤„ç†ï¼Œé¿å…Shellè„šæœ¬é‡å¤é€»è¾‘ï¼‰\n// æ³¨æ„ï¼šNode-RED functionèŠ‚ç‚¹ä¸­processå¯¹è±¡ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å€¼\n// Shellè„šæœ¬ä¼šåœ¨è¿è¡Œæ—¶æ£€æµ‹å®é™…å¹³å°å¹¶è¦†ç›–\nlet platform = 'X5'; // é»˜è®¤å¹³å°\nif (typeof global.vlmPlatform === 'undefined') {\n    // é»˜è®¤X5ï¼ŒShellè„šæœ¬ä¼šåœ¨è¿è¡Œæ—¶æ£€æµ‹å®é™…å¹³å°\n    platform = 'X5';\n    global.vlmPlatform = platform;\n} else {\n    platform = global.vlmPlatform;\n}\n\nnode.status({ fill: 'green', shape: 'dot', text: 'æ¨¡å‹: ' + (modelType === 'internvl' ? 'InternVL' : 'SmolVLM') + ' (' + platform + ')' });\n\n// æ ¹æ®æ¨¡å‹ç±»å‹å’Œå¹³å°è®¾ç½®é»˜è®¤å‚æ•°\nif (modelType === 'internvl') {\n    // InternVL é…ç½®\n    if (platform === 'S100') {\n        global.vlmModelType.modelFile = 'vit_model_int16.hbm';\n    } else {\n        global.vlmModelType.modelFile = 'vit_model_int16_v2.bin'; // X5å¹³å°é»˜è®¤\n    }\n    global.vlmModelType.llmModel = 'Qwen2.5-0.5B-Instruct-Q4_0.gguf';\n    global.vlmModelType.modelTypeParam = ''; // InternVLä¸éœ€è¦model_typeå‚æ•°\n} else if (modelType === 'smolvlm') {\n    // SmolVLM é…ç½®\n    if (platform === 'S100') {\n        global.vlmModelType.modelFile = 'SigLip_int16_SmolVLM2_256M_Instruct_S100.hbm';\n    } else {\n        global.vlmModelType.modelFile = 'SigLip_int16_SmolVLM2_256M_Instruct_MLP_C1_UP_X5.bin'; // X5å¹³å°é»˜è®¤\n    }\n    global.vlmModelType.llmModel = 'SmolVLM2-256M-Video-Instruct-Q8_0.gguf';\n    global.vlmModelType.modelTypeParam = '-p model_type:=1'; // SmolVLMéœ€è¦model_typeå‚æ•°\n}\n\n// ç¡®ä¿æç¤ºè¯å·²åˆå§‹åŒ–\nif (typeof global.vlmPrompt === 'undefined' || !global.vlmPrompt.current) {\n    global.vlmPrompt = {};\n    global.vlmPrompt.current = 'æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.';\n}\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "comment_photo_section",
        "type": "comment",
        "z": "vlm_tab",
        "name": "ğŸ“· æ‹ç…§æ¨ç†æµç¨‹",
        "info": "ç‚¹å‡»æ‹ç…§æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡ŒVLMæ¨ç†å¹¶æ˜¾ç¤ºæ–‡æœ¬ç»“æœ",
        "x": 150,
        "y": 300,
        "wires": []
    },
    {
        "id": "inject_take_photo",
        "type": "inject",
        "z": "vlm_tab",
        "name": "ğŸ“· USBæ‘„åƒå¤´æ‹ç…§",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 280,
        "wires": [
            [
                "rdk_camera_take_photo"
            ]
        ]
    },
    {
        "id": "rdk_camera_take_photo",
        "type": "rdk-camera takephoto",
        "z": "vlm_tab",
        "cameratype": "1",
        "filemode": "2",
        "filename": "photo.jpg",
        "filedefpath": "0",
        "filepath": "/home/sunrise/vlm_model",
        "fileformat": "jpeg",
        "resolution": "2",
        "rotation": "0",
        "fliph": "0",
        "flipv": "0",
        "brightness": "50",
        "contrast": "0",
        "sharpness": "0",
        "quality": "80",
        "imageeffect": "none",
        "exposuremode": "auto",
        "iso": "0",
        "agcwait": "1.0",
        "led": "0",
        "awb": "auto",
        "name": "æ‹ç…§",
        "x": 350,
        "y": 280,
        "wires": [
            [
                "function_prepare_vlm",
                "function_prepare_image_display"
            ]
        ]
    },
    {
        "id": "function_prepare_vlm",
        "type": "function",
        "z": "vlm_tab",
        "name": "å‡†å¤‡VLMæ¨ç†",
        "func": "// å‡†å¤‡VLMæ¨ç†ï¼šå¤„ç†å›¾ç‰‡è·¯å¾„å¹¶æ„å»ºå‘½ä»¤\n// ä½¿ç”¨å‰æ¨èè¿›è¡Œè®¾ç½®ï¼Œå‚è€ƒï¼šhttps://developer.d-robotics.cc/rdk_doc/rdk_s/Robot_development/boxs/generate/hobot_llamacpp\nconst self = node;\n\n// è¯»å–æç¤ºè¯å¹¶ä¿å­˜åˆ°æ¶ˆæ¯å¯¹è±¡\nmsg.vlmPrompt = global.get('vlmPrompt') || \"æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.\";\n\n// è·å–å¹¶å¤„ç†å›¾ç‰‡è·¯å¾„\nvar imagePath = msg.payload;\nif (typeof imagePath === 'string') {\n    imagePath = imagePath.trim();\n    if (imagePath.startsWith('~')) {\n        imagePath = imagePath.replace(/^~/, '/home/sunrise');\n    }\n    if (!imagePath.startsWith('/')) {\n        imagePath = '/home/sunrise/vlm_model/' + imagePath;\n    }\n} else {\n    imagePath = '/home/sunrise/vlm_model/photo.jpg';\n}\n\n// ç¡®ä¿ç›®å½•å­˜åœ¨\nconst imageDir = path.dirname(imagePath);\nif (!fs.existsSync(imageDir)) {\n    try {\n        fs.mkdirSync(imageDir, { recursive: true });\n    } catch (e) {\n        // å¿½ç•¥é”™è¯¯\n    }\n}\n\n// ç­‰å¾…æ–‡ä»¶ä¿å­˜å®Œæˆï¼ˆå¼‚æ­¥å¤„ç†ï¼‰\nconst finalImagePath = imagePath;\nif (fs.existsSync(finalImagePath)) {\n    self.status({ fill: 'green', shape: 'dot', text: 'âœ“ å›¾ç‰‡å·²å°±ç»ªï¼Œå‡†å¤‡å¯åŠ¨æ¨ç†...' });\n    buildVlmCommand(finalImagePath);\n} else {\n    self.status({ fill: 'yellow', shape: 'dot', text: 'ğŸ“· ç­‰å¾…å›¾ç‰‡ä¿å­˜å®Œæˆ...' });\n    let retryCount = 0;\n    const maxRetries = 6;\n    const checkFile = function() {\n        if (fs.existsSync(finalImagePath)) {\n            self.status({ fill: 'green', shape: 'dot', text: 'âœ“ å›¾ç‰‡å·²å°±ç»ªï¼Œå‡†å¤‡å¯åŠ¨æ¨ç†...' });\n            buildVlmCommand(finalImagePath);\n        } else if (retryCount < maxRetries) {\n            retryCount++;\n            self.status({ fill: 'yellow', shape: 'dot', text: 'ğŸ“· ç­‰å¾…å›¾ç‰‡ä¿å­˜å®Œæˆ... (' + retryCount + '/' + maxRetries + ')' });\n            setTimeout(checkFile, 500);\n        } else {\n            // è¶…æ—¶åå°è¯•æŸ¥æ‰¾æœ€æ–°å›¾ç‰‡\n            const dir = path.dirname(finalImagePath);\n            if (fs.existsSync(dir)) {\n                try {\n                    const files = fs.readdirSync(dir)\n                        .filter(file => file.toLowerCase().endsWith('.jpg') || file.toLowerCase().endsWith('.jpeg'))\n                        .map(file => {\n                            try {\n                                return { path: path.join(dir, file), mtime: fs.statSync(path.join(dir, file)).mtime };\n                            } catch (e) {\n                                return null;\n                            }\n                        })\n                        .filter(f => f !== null)\n                        .sort((a, b) => b.mtime - a.mtime);\n                    if (files.length > 0) {\n                        buildVlmCommand(files[0].path);\n                    } else {\n                        self.status({ fill: 'red', shape: 'dot', text: 'æ‰¾ä¸åˆ°å›¾ç‰‡æ–‡ä»¶' });\n                    }\n                } catch (e) {\n                    self.status({ fill: 'red', shape: 'dot', text: 'æŸ¥æ‰¾æ–‡ä»¶å¤±è´¥' });\n                }\n            } else {\n                self.status({ fill: 'red', shape: 'dot', text: 'ç›®å½•ä¸å­˜åœ¨' });\n            }\n        }\n    };\n    setTimeout(checkFile, 500);\n    return null;\n}\n\n// æ„å»ºVLMå‘½ä»¤\nfunction buildVlmCommand(imagePath) {\n    // è¯»å–æç¤ºè¯\n    var prompt = msg.vlmPrompt || global.get('vlmPrompt') || \"æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.\";\n    \n    // è¯»å–æ¨¡å‹é…ç½®\n    const modelType = (global.vlmModelType && global.vlmModelType.current) || 'internvl';\n    const llmModel = (global.vlmModelType && global.vlmModelType.llmModel) || 'Qwen2.5-0.5B-Instruct-Q4_0.gguf';\n    const modelTypeParam = (global.vlmModelType && global.vlmModelType.modelTypeParam) || '';\n    \n    // è½¬ä¹‰æç¤ºè¯\n    var escapedPrompt = prompt.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"');\n    var llmPath = \"/home/sunrise/vlm_model/\" + llmModel;\n    \n    // æ„å»ºå‘½ä»¤ï¼ˆåŒ…å«è¿è¡Œæ—¶å¹³å°æ£€æµ‹ï¼‰\n    var cmd = 'source /opt/tros/humble/setup.bash && ';\n    cmd += 'PLATFORM=$(cat /proc/device-tree/model 2>/dev/null | strings | grep -oE \"(X5|S100)\" | head -1 || echo \"X5\") && ';\n    cmd += 'if [ \"$PLATFORM\" = \"S100\" ]; then MODEL_FILE=\"vit_model_int16.hbm\"; else MODEL_FILE=\"vit_model_int16_v2.bin\"; fi && ';\n    cmd += 'MODEL_PATH=\"/home/sunrise/vlm_model/$MODEL_FILE\" && ';\n    cmd += 'ros2 run hobot_llamacpp hobot_llamacpp --ros-args ';\n    cmd += '-p feed_type:=0 -p image_type:=0 ';\n    cmd += '-p image:=' + imagePath + ' ';\n    cmd += '-p user_prompt:=\"' + escapedPrompt + '\" ';\n    cmd += '-p model_file_name:=$MODEL_PATH ';\n    cmd += '-p llm_model_name:=' + llmPath;\n    \n    if (modelTypeParam) {\n        cmd += ' ' + modelTypeParam;\n    }\n    \n    // è¾“å‡ºå‘½ä»¤\n    const newMsg = {\n        payload: cmd,\n        imagePath: imagePath,\n        _msgid: msg._msgid\n    };\n    \n    self.status({ fill: 'blue', shape: 'dot', text: 'ğŸš€ æ­£åœ¨å¯åŠ¨VLMæ¨ç†å¼•æ“...' });\n    self.send(newMsg);\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "path",
                "module": "path"
            }
        ],
        "x": 550,
        "y": 280,
        "wires": [
            [
                "exec_start_vlm",
                "function_start_topic_subscriber"
            ]
        ]
    },
    {
        "id": "exec_start_vlm",
        "type": "exec",
        "z": "vlm_tab",
        "name": "å¯åŠ¨VLMæ¨ç†",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": true,
        "timer": "600",
        "oldrc": false,
        "x": 750,
        "y": 280,
        "wires": [
            [
                "function_parse_vlm_result"
            ],
            [
                "function_check_error",
                "debug_vlm_error"
            ],
            []
        ]
    },
    {
        "id": "exec_echo_topic",
        "type": "exec",
        "z": "vlm_tab",
        "name": "è®¢é˜…Topicæ•°æ®",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": true,
        "timer": "90",
        "oldrc": false,
        "x": 950,
        "y": 320,
        "wires": [
            [
                "function_parse_topic_result"
            ],
            [],
            []
        ]
    },
    {
        "id": "function_parse_topic_result",
        "type": "function",
        "z": "vlm_tab",
        "name": "è§£æTopicç»“æœ",
        "func": "// è§£æROS Topicè¾“å‡ºçš„æ¨ç†ç»“æœï¼ˆä¼˜å…ˆä½¿ç”¨æ­¤æ–¹æ³•ï¼‰\n// Topicè¾“å‡ºæ ¼å¼é€šå¸¸æ˜¯ std_msgs/Stringï¼Œæ ¼å¼ä¸ºï¼šdata: \"æ¨ç†ç»“æœæ–‡æœ¬\"\n\nlet output = '';\nif (Buffer.isBuffer(msg.payload)) {\n    output = msg.payload.toString('utf8');\n} else if (typeof msg.payload === 'string') {\n    output = msg.payload;\n} else {\n    output = String(msg.payload || '');\n}\n\n// æ£€æŸ¥æ˜¯å¦æ˜¯ROS2 daemoné”™è¯¯\nif (output.includes('RuntimeError') || output.includes('rclpy.ok()') || output.includes('xmlrpc.client.Fault') || output.includes('Fault 1') || output.includes('Unable to communicate') || output.includes('Failed to communicate')) {\n    // ROS2 daemoné”™è¯¯ï¼Œæ ‡è®°ä¸ºå·²å°è¯•ï¼Œåç»­ä½¿ç”¨stdoutè§£æ\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true;\n    node.warn('ROS2 daemoné”™è¯¯ï¼Œæ— æ³•è®¢é˜…Topicï¼Œå°†ä½¿ç”¨stdoutè§£æã€‚æç¤ºï¼šä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å°è¯•ä¿®å¤daemonã€‚');\n    node.status({ fill: 'yellow', shape: 'dot', text: 'ROS2 daemoné”™è¯¯ï¼Œä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// æ£€æŸ¥Topicæ˜¯å¦å­˜åœ¨çš„é”™è¯¯ä¿¡æ¯\nif (output.includes('does not appear to be published') || \n    output.includes('Could not determine the type') || \n    output.includes('topic does not exist') ||\n    output.includes('Topic not found')) {\n    // Topicä¸å­˜åœ¨ï¼Œæ ‡è®°ä¸ºå·²å°è¯•ï¼Œåç»­ä½¿ç”¨stdoutè§£æ\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true;\n    node.warn('Topicä¸å­˜åœ¨æˆ–æœªå‘å¸ƒï¼Œå°†ä½¿ç”¨stdoutè§£æã€‚è¾“å‡º: ' + output.substring(0, 200));\n    node.status({ fill: 'yellow', shape: 'dot', text: 'Topicä¸å­˜åœ¨ï¼Œä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// è¿‡æ»¤æ‰ç©ºè¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯\nif (!output || output.trim().length === 0) {\n    // Topicæ— æ•°æ®ï¼Œæ ‡è®°ä¸ºå·²å°è¯•ï¼Œåç»­ä½¿ç”¨stdoutè§£æ\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true; // æ ‡è®°å·²å°è¯•\n    node.status({ fill: 'yellow', shape: 'dot', text: 'Topicæ— æ•°æ®ï¼Œå°†ä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// è¿‡æ»¤æ‰æ˜æ˜¾çš„é”™è¯¯ä¿¡æ¯æˆ–ç©ºæ¶ˆæ¯\nif (output.trim() === '' || output.includes('ERROR') || output.includes('é”™è¯¯')) {\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true;\n    node.status({ fill: 'yellow', shape: 'dot', text: 'Topicè¿”å›é”™è¯¯ï¼Œå°†ä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// æå–dataå­—æ®µçš„å€¼ï¼ˆROS2 topic echoçš„è¾“å‡ºæ ¼å¼ï¼‰\n// æ ¼å¼å¯èƒ½æ˜¯ï¼šdata: \"æ¨ç†ç»“æœ\" æˆ– data: 'æ¨ç†ç»“æœ' æˆ– ç›´æ¥æ˜¯æ¨ç†ç»“æœ\nlet result = '';\n\n// å°è¯•åŒ¹é… data: \"...\" æ ¼å¼\nconst dataMatch = output.match(/data:\\s*[\"']([^\"']+)[\"']/);\nif (dataMatch && dataMatch[1]) {\n    result = dataMatch[1].trim();\n} else {\n    // å°è¯•åŒ¹é… data: ... æ ¼å¼ï¼ˆæ— å¼•å·ï¼‰\n    const dataMatch2 = output.match(/data:\\s*(.+)/);\n    if (dataMatch2 && dataMatch2[1]) {\n        result = dataMatch2[1].trim();\n    } else {\n        // å¦‚æœæ²¡æœ‰dataå­—æ®µï¼Œå°è¯•ç›´æ¥æå–å¼•å·å†…çš„å†…å®¹\n        const quoteMatch = output.match(/[\"']([^\"']+)[\"']/);\n        if (quoteMatch && quoteMatch[1]) {\n            result = quoteMatch[1].trim();\n        } else {\n            // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨æ•´ä¸ªè¾“å‡ºï¼ˆå»é™¤ROS2 topic echoçš„å…ƒæ•°æ®ï¼‰\n            const lines = output.split(/[\\r\\n]+/).filter(line => {\n                const trimmed = line.trim();\n                return trimmed.length > 0 && \n                       !trimmed.startsWith('---') && \n                       !trimmed.match(/^data:/) &&\n                       !trimmed.match(/^std_msgs/);\n            });\n            if (lines.length > 0) {\n                result = lines.join(' ').trim();\n            }\n        }\n    }\n}\n\n// æ¸…ç†ç»“æœï¼šå»é™¤ROS2 topic echoçš„å…ƒæ•°æ®\nresult = result.replace(/^data:\\s*/i, '').replace(/^[\"']|[\"']$/g, '').trim();\n\n// å¦‚æœç»“æœå¤ªçŸ­æˆ–çœ‹èµ·æ¥ä¸åƒæ¨ç†ç»“æœï¼Œå¿½ç•¥\nif (!result || result.length < 5) {\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true;\n    node.status({ fill: 'yellow', shape: 'dot', text: 'Topicæ•°æ®æ— æ•ˆï¼Œå°†ä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯ä¿¡æ¯æˆ–echoè¾“å‡ºï¼ˆä¸åº”è¯¥ä»Topicä¸­è·å–ï¼‰\nif (result.includes('ERROR') || result.includes('é”™è¯¯') || result.match(/^\\s*$/) ||\n    result.match(/^(å›¾ç‰‡æ–‡ä»¶|æç¤ºè¯|æ¨¡å‹æ–‡ä»¶|è®¾å¤‡ä¿¡æ¯|å¹³å°|å·¥ä½œç›®å½•|æ£€æµ‹åˆ°å¹³å°):/i) ||\n    result.match(/.*:\\s*\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i)) {\n    const msgId = msg._msgid || 'default';\n    if (typeof global.vlmTopicSubscribed === 'undefined') {\n        global.vlmTopicSubscribed = {};\n    }\n    global.vlmTopicSubscribed[msgId] = true;\n    node.status({ fill: 'yellow', shape: 'dot', text: 'Topicæ•°æ®å¼‚å¸¸ï¼Œå°†ä½¿ç”¨stdoutè§£æ' });\n    return null;\n}\n\n// æ‰¾åˆ°æœ‰æ•ˆç»“æœï¼Œæ ‡è®°Topicå·²æˆåŠŸè·å–ç»“æœ\nconst msgId = msg._msgid || 'default';\nif (typeof global.vlmTopicSubscribed === 'undefined') {\n    global.vlmTopicSubscribed = {};\n}\nglobal.vlmTopicSubscribed[msgId] = true; // æ ‡è®°Topicå·²æˆåŠŸè·å–ç»“æœ\n\n// æ ‡è®°æ­¤ç»“æœæ¥è‡ªTopicï¼Œä¼˜å…ˆçº§æœ€é«˜\nmsg.result = result;\nmsg.source = 'ros_topic';\nmsg.fullOutput = output;\nmsg.fromTopic = true; // æ ‡è®°æ¥è‡ªTopicï¼Œstdoutè§£æåº”è¯¥å¿½ç•¥\n\nnode.status({ fill: 'green', shape: 'dot', text: 'âœ“ Topicç»“æœ: ' + result.substring(0, 30) + '...' });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 320,
        "wires": [
            [
                "debug_vlm_result"
            ]
        ]
    },
    {
        "id": "function_check_error",
        "type": "function",
        "z": "vlm_tab",
        "name": "æ£€æŸ¥é”™è¯¯ï¼ˆéšè—ï¼‰",
        "func": "// æ£€æŸ¥é”™è¯¯è¾“å‡ºå’Œé€€å‡ºç \n// ä¼˜å…ˆæ£€æŸ¥BPUå†…å­˜é”™è¯¯ï¼Œç„¶åæ£€æŸ¥é€€å‡ºç \nlet errorOutput = '';\nif (Buffer.isBuffer(msg.payload)) {\n    errorOutput = msg.payload.toString('utf8');\n} else if (typeof msg.payload === 'string') {\n    errorOutput = msg.payload;\n} else {\n    errorOutput = String(msg.payload || '');\n}\n\n// é¦–å…ˆæ£€æŸ¥BPUå†…å­˜åˆ†é…é”™è¯¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰\n// BPUé”™è¯¯å…³é”®è¯\nconst bpuErrorKeywords = ['hbUCPMallocMem', 'hb_mem_alloc', 'hb_mem', 'MallocMem failed', 'allocate', 'allocation failed', 'ret: -400001', 'ret: -16777211', 'ION_ALLOCATOR', 'Fail to allocate', 'Insufficient memory', 'Fail to do ION_IOC_ALLOC'];\nlet hasBpuError = false;\nfor (const keyword of bpuErrorKeywords) {\n    if (errorOutput.includes(keyword)) {\n        hasBpuError = true;\n        break;\n    }\n}\n\n// å¦‚æœæ£€æµ‹åˆ°BPUé”™è¯¯ï¼Œæ£€æŸ¥Topicæ˜¯å¦å¯èƒ½æœ‰ç»“æœï¼ˆä¼˜å…ˆä½¿ç”¨Topicç»“æœï¼‰\nif (hasBpuError) {\n    const msgId = msg._msgid || 'default';\n    // æ£€æŸ¥Topicæ˜¯å¦å·²ç»å°è¯•è·å–ç»“æœ\n    const topicTried = typeof global.vlmTopicSubscribed !== 'undefined' && global.vlmTopicSubscribed[msgId];\n    \n    // å¦‚æœTopicè¿˜æ²¡æœ‰å°è¯•ï¼Œæš‚æ—¶ä¸è¿”å›é”™è¯¯ï¼Œç­‰å¾…Topicç»“æœ\n    if (!topicTried) {\n        // Topicè¿˜æ²¡æœ‰å°è¯•ï¼Œå¯èƒ½è¿˜åœ¨ç­‰å¾…Topicç»“æœï¼Œæš‚æ—¶ä¸è¿”å›é”™è¯¯\n        node.status({ fill: 'yellow', shape: 'dot', text: 'æ£€æµ‹åˆ°BPUé”™è¯¯ï¼Œç­‰å¾…Topicç»“æœ...' });\n        return null;\n    }\n    \n    // å¦‚æœTopicå·²ç»å°è¯•ä½†æ²¡æœ‰ç»“æœï¼Œè¿”å›BPUé”™è¯¯\n    // ä½†ä¸è¦ç«‹å³è¿”å›ï¼Œè®©stdoutè§£æèŠ‚ç‚¹å¤„ç†ï¼ˆå®ƒä¹Ÿä¼šæ£€æŸ¥Topicï¼‰\n    // è¿™é‡Œåªæ ‡è®°é”™è¯¯ï¼Œä¸è¿”å›ï¼Œè®©stdoutè§£æèŠ‚ç‚¹ç»Ÿä¸€å¤„ç†\n    node.status({ fill: 'yellow', shape: 'dot', text: 'æ£€æµ‹åˆ°BPUé”™è¯¯ï¼Œç­‰å¾…stdoutè§£æ...' });\n    return null;\n}\n\n// æ£€æŸ¥é€€å‡ºç ï¼ˆmsg.rcï¼‰\n// msg.rcå¯èƒ½æ˜¯æ•°å­—ã€å¯¹è±¡æˆ–undefinedï¼Œéœ€è¦æ­£ç¡®æå–\nlet exitCode = 0;\nlet exitCodeStr = '0';\n\ntry {\n    if (typeof msg.rc === 'number') {\n        exitCode = msg.rc;\n        exitCodeStr = String(msg.rc);\n    } else if (typeof msg.rc === 'object' && msg.rc !== null) {\n        // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–codeå±æ€§æˆ–è½¬æ¢ä¸ºæ•°å­—\n        // å…ˆå°è¯•å¸¸è§çš„å±æ€§å\n        exitCode = msg.rc.code || msg.rc.exitCode || msg.rc.status || msg.rc.rc;\n        // å¦‚æœè¿˜æ˜¯NaNæˆ–undefinedï¼Œå°è¯•JSONåºåˆ—åŒ–åè§£æ\n        if (isNaN(exitCode) || exitCode === undefined || exitCode === null) {\n            try {\n                const rcStr = JSON.stringify(msg.rc);\n                // å°è¯•ä»JSONå­—ç¬¦ä¸²ä¸­æå–æ•°å­—\n                const numMatch = rcStr.match(/\\d+/);\n                if (numMatch) {\n                    exitCode = parseInt(numMatch[0]) || 0;\n                } else {\n                    exitCode = 0;\n                }\n            } catch (e) {\n                exitCode = 0;\n            }\n        }\n        exitCodeStr = String(exitCode);\n        // å¦‚æœæå–å¤±è´¥ï¼Œä¿å­˜åŸå§‹å¯¹è±¡ç”¨äºè°ƒè¯•\n        if (exitCode === 0 && msg.rc !== null) {\n            try {\n                exitCodeStr = 'object: ' + JSON.stringify(msg.rc).substring(0, 100);\n            } catch (e) {\n                exitCodeStr = 'object: [æ— æ³•åºåˆ—åŒ–]';\n            }\n        }\n    } else if (typeof msg.rc === 'string') {\n        exitCode = parseInt(msg.rc) || 0;\n        exitCodeStr = msg.rc;\n    } else {\n        // å¦‚æœæ²¡æœ‰rcæˆ–rcä¸ºnull/undefinedï¼Œé»˜è®¤ä¸º0ï¼ˆå¯èƒ½è¿˜åœ¨æ‰§è¡Œä¸­ï¼‰\n        exitCode = 0;\n        exitCodeStr = '0 (no rc)';\n    }\n} catch (e) {\n    // å¦‚æœæå–å¤±è´¥ï¼Œè®°å½•åŸå§‹å€¼ç”¨äºè°ƒè¯•\n    exitCode = 0;\n    try {\n        exitCodeStr = 'error: ' + String(msg.rc).substring(0, 100);\n    } catch (e2) {\n        exitCodeStr = 'error: [æ— æ³•è½¬æ¢]';\n    }\n}\n\n// åªæœ‰å½“é€€å‡ºç ä¸ä¸º0æ—¶æ‰è®¤ä¸ºæ˜¯é”™è¯¯ï¼ˆ0è¡¨ç¤ºæˆåŠŸï¼‰\n// æ³¨æ„ï¼š250å¯èƒ½æ˜¯è¶…æ—¶é”™è¯¯ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯BPUé”™è¯¯å¯¼è‡´çš„é€€å‡º\nif (exitCode !== 0) {\n    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„è¶…æ—¶é”™è¯¯ï¼ˆä¸åŒ…å«BPUé”™è¯¯ï¼‰\n    const isTimeout = (errorOutput.includes('timeout') || errorOutput.includes('è¶…æ—¶')) && !hasBpuError;\n    \n    if (isTimeout || (exitCode === 250 && !hasBpuError)) {\n        // çœŸæ­£çš„è¶…æ—¶é”™è¯¯\n        node.error('VLMå‘½ä»¤æ‰§è¡Œè¶…æ—¶æˆ–å¤±è´¥ï¼Œé€€å‡ºç : ' + exitCodeStr);\n        node.status({ fill: 'red', shape: 'dot', text: 'æ‰§è¡Œè¶…æ—¶ (é€€å‡ºç : ' + exitCodeStr + ')' });\n        \n        // è¿”å›é”™è¯¯æ¶ˆæ¯\n        msg.isError = true;\n        msg.errorType = 'timeout';\n        msg.errorMessage = 'VLMå‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œé€€å‡ºç : ' + exitCodeStr + '\\nè¯·æ£€æŸ¥ï¼š\\n1. æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨\\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\\n3. è®¾å¤‡èµ„æºæ˜¯å¦å……è¶³\\n4. å‘½ä»¤æ˜¯å¦è¶…æ—¶ï¼ˆå½“å‰è¶…æ—¶æ—¶é—´ï¼š600ç§’ï¼‰\\n5. å¦‚æœæ‰‹åŠ¨è¿è¡Œå‘½ä»¤æ­£å¸¸ï¼Œå¯èƒ½æ˜¯Node-REDæ‰§è¡Œç¯å¢ƒé—®é¢˜';\n        msg.rc = exitCode;\n        msg.originalRc = msg.rc; // ä¿å­˜åŸå§‹çš„rcå€¼ç”¨äºè°ƒè¯•\n        return msg;\n    }\n    \n    // å¦‚æœé€€å‡ºç æ˜¯250ä½†åŒ…å«BPUé”™è¯¯ï¼Œä¸åœ¨è¿™é‡Œå¤„ç†ï¼Œè®©stdoutè§£æèŠ‚ç‚¹å¤„ç†\n    if (exitCode === 250 && hasBpuError) {\n        // BPUé”™è¯¯å¯¼è‡´çš„é€€å‡ºï¼Œè®©stdoutè§£æèŠ‚ç‚¹ç»Ÿä¸€å¤„ç†\n        node.status({ fill: 'yellow', shape: 'dot', text: 'BPUé”™è¯¯å¯¼è‡´é€€å‡ºï¼Œç­‰å¾…stdoutè§£æ...' });\n        return null;\n    }\n    \n    // æ£€æŸ¥é€€å‡ºç 245ï¼ˆå¯èƒ½æ˜¯å‘½ä»¤è¢«killæˆ–æŸç§è¶…æ—¶ï¼‰\n    if (exitCode === 245) {\n        // é€€å‡ºç 245é€šå¸¸è¡¨ç¤ºå‘½ä»¤è¢«ç»ˆæ­¢ï¼Œå¯èƒ½æ˜¯è¶…æ—¶æˆ–èµ„æºé—®é¢˜\n        node.error('VLMå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : 245ï¼ˆå‘½ä»¤è¢«ç»ˆæ­¢ï¼‰');\n        node.status({ fill: 'red', shape: 'dot', text: 'å‘½ä»¤è¢«ç»ˆæ­¢ (é€€å‡ºç : 245)' });\n        \n        msg.isError = true;\n        msg.errorType = 'command_terminated';\n        msg.errorMessage = 'VLMå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : 245ï¼ˆå‘½ä»¤è¢«ç»ˆæ­¢ï¼‰\\n\\nå¯èƒ½åŸå› ï¼š\\n1. å‘½ä»¤æ‰§è¡Œæ—¶é—´è¿‡é•¿è¢«kill\\n2. ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆå†…å­˜/BPUï¼‰\\n3. æ¨¡å‹æ–‡ä»¶è·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨\\n4. å›¾ç‰‡æ–‡ä»¶è·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨\\n5. ros2å‘½ä»¤å‚æ•°æ ¼å¼é”™è¯¯\\n\\nå»ºè®®ï¼š\\n1. æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨: /home/sunrise/vlm_model/vit_model_int16_v2.bin\\n2. æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨: ' + (msg.imagePath || 'æœªçŸ¥è·¯å¾„') + '\\n3. æ£€æŸ¥BPUèµ„æºæ˜¯å¦å……è¶³\\n4. æŸ¥çœ‹Debugé¢æ¿è·å–æ›´å¤šé”™è¯¯ä¿¡æ¯\\n\\né”™è¯¯è¾“å‡º: ' + errorOutput.substring(0, 1000);\n        msg.rc = exitCode;\n        msg.originalRc = msg.rc;\n        return msg;\n    }\n    \n    // å…¶ä»–é”™è¯¯\n    node.error('VLMå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : ' + exitCodeStr);\n    node.status({ fill: 'red', shape: 'dot', text: 'æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : ' + exitCodeStr + ')' });\n    \n    msg.isError = true;\n    msg.errorType = 'execution_failed';\n    msg.errorMessage = 'VLMå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : ' + exitCodeStr + '\\né”™è¯¯è¾“å‡º: ' + errorOutput.substring(0, 500);\n    msg.rc = exitCode;\n    msg.originalRc = msg.rc; // ä¿å­˜åŸå§‹çš„rcå€¼ç”¨äºè°ƒè¯•\n    return msg;\n}\n\n// è¿‡æ»¤wgetä¸‹è½½è¿›åº¦ä¿¡æ¯ï¼ˆè¿™äº›ä¸åº”è¯¥è¢«å½“ä½œé”™è¯¯ï¼‰\n// wgetè¿›åº¦æ ¼å¼ï¼šæ•°å­—K/M + ç‚¹ + ç™¾åˆ†æ¯” + é€Ÿåº¦ + æ—¶é—´\nif (errorOutput.match(/^\\s*\\d+[KM]\\s+[\\.]+\\s+\\d+%\\s+\\d+[KM]\\s+\\d+[ms]/m)) {\n    // è¿™æ˜¯wgetè¿›åº¦ä¿¡æ¯ï¼Œä¸æ˜¯é”™è¯¯ï¼Œå¿½ç•¥\n    return null;\n}\n\n// è¿‡æ»¤æ—¥å¿—ä¿¡æ¯ï¼ˆå¦‚[UCPT]: log level = 6ï¼‰\nif (errorOutput.match(/\\[UCPT\\]|log level|UCPT.*log/i)) {\n    // è¿™æ˜¯æ—¥å¿—ä¿¡æ¯ï¼Œä¸æ˜¯é”™è¯¯ï¼Œå¿½ç•¥\n    return null;\n}\n\n// å¿½ç•¥å…¶ä»–é”™è¯¯è¾“å‡ºï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†\n// å› ä¸ºVLMå‘½ä»¤å¯èƒ½ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä½†æ¨ç†ç»“æœä»ç„¶ä¼šåœ¨stdoutä¸­\n// æˆ‘ä»¬åªå…³æ³¨stdoutçš„è¾“å‡ºï¼Œstderrçš„é”™è¯¯ä¿¡æ¯ä¼šè¢«å¿½ç•¥\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "function_start_topic_subscriber",
        "type": "function",
        "z": "vlm_tab",
        "name": "å¯åŠ¨Topicè®¢é˜…",
        "func": "// å¯åŠ¨ROS Topicè®¢é˜…ï¼Œç­‰å¾…Topicå‘å¸ƒåå†è®¢é˜…\nconst msgId = msg._msgid || 'default';\nif (typeof global.vlmTopicSubscribed === 'undefined') {\n    global.vlmTopicSubscribed = {};\n}\nglobal.vlmTopicSubscribed[msgId] = false;\n\n// å»¶è¿Ÿ15ç§’åå¼€å§‹æ£€æŸ¥Topicæ˜¯å¦å­˜åœ¨ï¼Œç„¶åè®¢é˜…\n// ç¬¬ä¸€æ¬¡å¯åŠ¨VLMéœ€è¦æ›´é•¿æ—¶é—´ï¼Œæ‰€ä»¥å¢åŠ å»¶è¿Ÿ\nconst initialDelay = 15000; // 15ç§’åˆå§‹å»¶è¿Ÿ\n\n// æ·»åŠ å€’è®¡æ—¶æç¤º\nlet countdown = Math.floor(initialDelay / 1000);\nnode.status({ fill: 'blue', shape: 'dot', text: 'â³ ç­‰å¾…VLMå¯åŠ¨... (' + countdown + 'ç§’åå¼€å§‹è®¢é˜…Topic)' });\n\nconst countdownInterval = setInterval(() => {\n    countdown--;\n    if (countdown > 0) {\n        node.status({ fill: 'blue', shape: 'dot', text: 'â³ ç­‰å¾…VLMå¯åŠ¨... (' + countdown + 'ç§’åå¼€å§‹è®¢é˜…Topic)' });\n    } else {\n        clearInterval(countdownInterval);\n        node.status({ fill: 'blue', shape: 'dot', text: 'ğŸ” æ­£åœ¨æ£€æŸ¥Topicæ˜¯å¦å‘å¸ƒ...' });\n    }\n}, 1000);\n\nsetTimeout(() => {\n    clearInterval(countdownInterval);\n    node.status({ fill: 'blue', shape: 'dot', text: 'ğŸ” æ­£åœ¨æ£€æŸ¥Topicæ˜¯å¦å‘å¸ƒ...' });\n    \n    // å…ˆæ£€æŸ¥Topicæ˜¯å¦å­˜åœ¨ï¼Œç­‰å¾…æœ€å¤š30ç§’ï¼ˆæ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰\n    // ç„¶åä½¿ç”¨ros2 topic echoé˜»å¡ç­‰å¾…æ¶ˆæ¯ï¼ˆæœ€å¤š60ç§’ï¼‰\n    let cmd = 'source /opt/tros/humble/setup.bash 2>/dev/null && ';\n    cmd += 'for i in $(seq 1 30); do ';\n    cmd += '  if ros2 topic list 2>/dev/null | grep -q \"/tts_text\"; then break; fi; ';\n    cmd += '  sleep 1; ';\n    cmd += 'done && ';\n    cmd += 'timeout 60 ros2 topic echo /tts_text --once 2>&1 || echo \"\"';\n    \n    node.send({\n        _msgid: msg._msgid,\n        payload: cmd,\n        topicName: '/tts_text'\n    });\n    \n    // è®¾ç½®æ¸…ç†å®šæ—¶å™¨ï¼ˆ90ç§’åæ¸…ç†ï¼‰\n    setTimeout(() => {\n        if (global.vlmTopicSubscribed && global.vlmTopicSubscribed[msgId] !== undefined) {\n            delete global.vlmTopicSubscribed[msgId];\n        }\n    }, 90000);\n}, initialDelay);\n\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 280,
        "wires": [
            [
                "exec_echo_topic"
            ]
        ]
    },
    {
        "id": "function_parse_vlm_result",
        "type": "function",
        "z": "vlm_tab",
        "name": "è§£æç»“æœï¼ˆåå°ï¼‰",
        "func": "// è§£æVLMæ¨ç†ç»“æœï¼ˆä»stdoutè§£æï¼Œä½œä¸ºTopicçš„å¤‡é€‰æ–¹æ¡ˆï¼‰\n// ä¼˜å…ˆä½¿ç”¨ROS Topicè·å–ç»“æœï¼Œå¦‚æœTopicå·²æœ‰ç»“æœï¼Œåˆ™è·³è¿‡stdoutè§£æ\n\nconst msgId = msg._msgid || 'default';\n\n// æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰Topicç»“æœï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰\n// å¦‚æœTopicå·²ç»æˆåŠŸè·å–ç»“æœï¼Œç›´æ¥ä½¿ç”¨Topicç»“æœï¼Œè·³è¿‡stdoutè§£æ\nif (msg.fromTopic === true && msg.result) {\n    // Topicå·²æˆåŠŸè·å–ç»“æœï¼Œä¸éœ€è¦è§£æstdout\n    node.status({ fill: 'green', shape: 'dot', text: 'å·²ä½¿ç”¨Topicç»“æœï¼Œè·³è¿‡stdoutè§£æ' });\n    // æ¸…é™¤ç¼“å†²åŒº\n    if (typeof global.vlmOutputBuffer !== 'undefined' && global.vlmOutputBuffer[msgId]) {\n        delete global.vlmOutputBuffer[msgId];\n    }\n    return null;\n}\n\n// æ£€æŸ¥Topicæ˜¯å¦å·²ç»å°è¯•è·å–ç»“æœ\nif (typeof global.vlmTopicSubscribed !== 'undefined' && global.vlmTopicSubscribed[msgId]) {\n    // Topicå·²å°è¯•è·å–ç»“æœï¼Œå¦‚æœmsg.fromTopicä¸ºtrueï¼Œè¯´æ˜Topicå·²æˆåŠŸè·å–ç»“æœï¼Œè·³è¿‡stdoutè§£æ\n    if (msg.fromTopic === true) {\n        // Topicå·²æˆåŠŸè·å–ç»“æœï¼Œä¸éœ€è¦è§£æstdout\n        node.status({ fill: 'blue', shape: 'dot', text: 'å·²ä½¿ç”¨Topicç»“æœï¼Œè·³è¿‡stdoutè§£æ' });\n        return null;\n    }\n    // å¦‚æœTopicå°è¯•äº†ä½†æ²¡æœ‰ç»“æœï¼Œç»§ç»­ä½¿ç”¨stdoutè§£æä½œä¸ºå¤‡é€‰\n}\n\n// åˆå§‹åŒ–å…¨å±€ç¼“å†²åŒº\nif (typeof global.vlmOutputBuffer === 'undefined') {\n    global.vlmOutputBuffer = {};\n}\n\nif (!global.vlmOutputBuffer[msgId]) {\n    global.vlmOutputBuffer[msgId] = '';\n}\n\n// å¤„ç†bufferæ ¼å¼çš„è¾“å‡º\nlet chunk = '';\nif (Buffer.isBuffer(msg.payload)) {\n    // å°è¯•UTF-8è§£ç \n    try {\n        chunk = msg.payload.toString('utf8');\n    } catch (e) {\n        // å¦‚æœUTF-8å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç¼–ç \n        try {\n            chunk = msg.payload.toString('latin1');\n        } catch (e2) {\n            chunk = msg.payload.toString();\n        }\n    }\n} else if (typeof msg.payload === 'string') {\n    chunk = msg.payload;\n} else {\n    chunk = String(msg.payload || '');\n}\n\n// ç´¯ç§¯è¾“å‡º\nif (chunk) {\n    global.vlmOutputBuffer[msgId] += chunk;\n}\n\nconst output = global.vlmOutputBuffer[msgId];\n\n// æ£€æŸ¥è¾“å‡ºæ˜¯å¦è¢«æˆªæ–­ï¼ˆåªåŒ…å«å¯åŠ¨ä¿¡æ¯ä½†æ²¡æœ‰æ¨ç†ç»“æœï¼‰\nconst hasStartMessage = output.includes('å¼€å§‹VLMæ¨ç†') || output.includes('å¯èƒ½éœ€è¦10-30ç§’');\nconst hasEndMessage = output.includes('===') && output.split('===').length > 2;\n\n// å¦‚æœè¾“å‡ºå¤ªçŸ­ï¼Œå¯èƒ½è¿˜åœ¨å¤„ç†ä¸­ï¼Œç­‰å¾…æ›´å¤šæ•°æ®\nif (!output || output.trim().length < 30) {\n    node.status({ fill: 'yellow', shape: 'dot', text: 'â³ VLMæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™...' });\n    return null;\n}\n\n// å¦‚æœè¾“å‡ºåªåŒ…å«å¯åŠ¨ä¿¡æ¯ä½†æ²¡æœ‰åç»­å†…å®¹ï¼Œå¯èƒ½è¾“å‡ºè¢«æˆªæ–­\nif (hasStartMessage && !hasEndMessage && output.length < 500) {\n    // æ£€æŸ¥æ˜¯å¦åŒ…å«ros2å‘½ä»¤çš„è¾“å‡º\n    const hasRos2Output = output.includes('ros2') || output.includes('hobot_llamacpp') || output.includes('llamacpp_node');\n    if (!hasRos2Output) {\n        // å¯èƒ½è¾“å‡ºè¢«æˆªæ–­ï¼Œç­‰å¾…æ›´å¤šæ•°æ®\n        node.status({ fill: 'yellow', shape: 'dot', text: 'â³ VLMæ­£åœ¨åŠ è½½æ¨¡å‹ï¼Œè¯·ç¨å€™...' });\n        return null;\n    }\n}\n\n// æŸ¥æ‰¾æ¨ç†ç»“æœ\n// VLMçš„è¾“å‡ºæ ¼å¼ï¼šæ¨ç†ç»“æœé€šå¸¸åœ¨æœ€åï¼Œå¯èƒ½è¢«æ—¥å¿—ä¿¡æ¯åŒ…å›´\nconst lines = output.split(/[\\r\\n]+/).filter(line => line.trim().length > 0);\n\n// æ’é™¤çš„æ—¥å¿—å…³é”®è¯ï¼ˆåŒ…æ‹¬å¯åŠ¨ä¿¡æ¯å’Œechoè¾“å‡ºï¼‰\nconst logKeywords = [\n    'INFO', 'WARN', 'ERROR', 'DEBUG', 'TRACE',\n    '===', 'å·¥ä½œç›®å½•', 'å›¾ç‰‡æ–‡ä»¶', 'æ¨¡å‹ç±»å‹', 'æç¤ºè¯', 'æ£€æŸ¥', 'å¯åŠ¨',\n    'ros2', 'source', 'cd', 'cp', 'echo', 'ls',\n    'llamacpp_node', 'This is llama',\n    '[DNN]', 'HBRT', 'version', '3.7.3',\n    'image encoder', 'prefill', 'eval time',\n    'å¼€å§‹', 'å¯åŠ¨', 'å®Œæˆ', 'ç»“æŸ',\n    'bash', 'setup.bash', 'hobot_llamacpp',\n    '[UCPT]', 'log level', 'UCPT', // æ·»åŠ UCPTæ—¥å¿—è¿‡æ»¤\n    'wget', 'ä¸‹è½½', 'Download', 'è¿›åº¦', 'progress', // æ·»åŠ ä¸‹è½½ç›¸å…³è¿‡æ»¤\n    'å¹³å°è¦æ±‚', 'âš ', 'æ£€æµ‹åˆ°å¹³å°', 'è®¾å¤‡ä¿¡æ¯', // æ·»åŠ å¹³å°æ£€æµ‹ç›¸å…³è¿‡æ»¤\n    'æ¨¡å‹æ–‡ä»¶æ£€æŸ¥', 'å¯åŠ¨VLMæ¨ç†', 'æç¤ºè¯:', 'å›¾ç‰‡æ–‡ä»¶:', // æ·»åŠ çŠ¶æ€ä¿¡æ¯è¿‡æ»¤\n    'æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨', 'å¼€å§‹è‡ªåŠ¨ä¸‹è½½', 'ä¸‹è½½å®Œæˆ', 'ä¸‹è½½å¤±è´¥', // æ·»åŠ ä¸‹è½½çŠ¶æ€è¿‡æ»¤\n    'å¹³å°æ£€æµ‹', 'è®¾å¤‡ä¿¡æ¯', 'æ£€æµ‹åˆ°å¹³å°', // æ·»åŠ å¹³å°æ£€æµ‹è¿‡æ»¤\n    'æ£€æŸ¥æ¨¡å‹æ–‡ä»¶', 'æ¨¡å‹æ–‡ä»¶æ£€æŸ¥é€šè¿‡', 'å¯åŠ¨VLMæ¨ç†', // æ·»åŠ å¯åŠ¨æµç¨‹è¿‡æ»¤\n    'å¯èƒ½éœ€è¦', 'è¯·è€å¿ƒç­‰å¾…', 'å¼€å§‹VLMæ¨ç†', // æ·»åŠ æç¤ºä¿¡æ¯è¿‡æ»¤\n    'å¯èƒ½éœ€è¦10-30ç§’', 'è¯·è€å¿ƒç­‰å¾…', 'å¼€å§‹VLMæ¨ç†ï¼ˆå¯èƒ½éœ€è¦', // æ·»åŠ å¯åŠ¨æç¤ºè¿‡æ»¤\n    '/tmp/', '/opt/', '/dev/', 'image-', 'photo.jpg', // æ·»åŠ è·¯å¾„å’Œæ–‡ä»¶åè¿‡æ»¤\n    'hbUCPMallocMem', 'hb_mem_alloc', 'hb_mem', 'MallocMem failed', 'allocate', 'allocation failed', 'ret: -400001', 'ret: -16777211', 'ION_ALLOCATOR', 'Fail to allocate', 'Insufficient memory', // æ·»åŠ BPUå†…å­˜é”™è¯¯è¿‡æ»¤\n    '[BPU_PLAT]', 'BPU_PLAT', 'BPU Platform', 'Platform Version', 'BPU Platform Version' // æ·»åŠ BPUå¹³å°ç‰ˆæœ¬ä¿¡æ¯è¿‡æ»¤ // æ·»åŠ BPUå†…å­˜é”™è¯¯è¿‡æ»¤\n];\n\n// å¯åŠ¨ä¿¡æ¯å’Œechoè¾“å‡ºæ¨¡å¼ï¼ˆè¿™äº›ä¸åº”è¯¥è¢«è¯†åˆ«ä¸ºç»“æœï¼‰\n// ç‰¹åˆ«æ³¨æ„ï¼šä¸¥æ ¼è¿‡æ»¤æ‰€æœ‰echoè¾“å‡ºï¼ŒåŒ…æ‹¬å›¾ç‰‡æ–‡ä»¶æç¤ºã€æç¤ºè¯æç¤ºç­‰\nconst startInfoPatterns = [\n    /å¯èƒ½éœ€è¦.*ç§’.*è¯·è€å¿ƒç­‰å¾…/i,\n    /å¼€å§‹VLMæ¨ç†.*å¯èƒ½éœ€è¦/i,\n    /===.*å¼€å§‹.*æ¨ç†.*===/i,\n    /^===.*å¼€å§‹/i,\n    /.*å¯èƒ½éœ€è¦.*ç§’.*è¯·è€å¿ƒç­‰å¾….*===/i,\n    /å›¾ç‰‡æ–‡ä»¶:.*/i, // echoè¾“å‡ºï¼šå›¾ç‰‡æ–‡ä»¶è·¯å¾„æç¤º\n    /æç¤ºè¯:.*/i, // echoè¾“å‡ºï¼šæç¤ºè¯æç¤º\n    /^å›¾ç‰‡æ–‡ä»¶:/i, // ä»¥å›¾ç‰‡æ–‡ä»¶å¼€å¤´çš„è¡Œï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰\n    /^æç¤ºè¯:/i, // ä»¥æç¤ºè¯å¼€å¤´çš„è¡Œï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰\n    /^æ¨¡å‹æ–‡ä»¶:/i, // ä»¥æ¨¡å‹æ–‡ä»¶å¼€å¤´çš„è¡Œ\n    /^è®¾å¤‡ä¿¡æ¯:/i, // ä»¥è®¾å¤‡ä¿¡æ¯å¼€å¤´çš„è¡Œ\n    /^å¹³å°:/i, // ä»¥å¹³å°å¼€å¤´çš„è¡Œ\n    /^å·¥ä½œç›®å½•:/i, // ä»¥å·¥ä½œç›®å½•å¼€å¤´çš„è¡Œ\n    /^æ£€æµ‹åˆ°å¹³å°:/i, // ä»¥æ£€æµ‹åˆ°å¹³å°å¼€å¤´çš„è¡Œ\n    /.*\\/tmp\\/.*\\.(jpg|jpeg|png)/i, // åŒ…å«/tmp/è·¯å¾„çš„å›¾ç‰‡æ–‡ä»¶\n    /.*image-\\d{8}-\\d{6}\\.(jpg|jpeg)/i, // æ—¶é—´æˆ³æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶å\n    /^echo.*å›¾ç‰‡æ–‡ä»¶/i, // echoå‘½ä»¤è¾“å‡º\n    /^echo.*æç¤ºè¯/i // echoå‘½ä»¤è¾“å‡º\n];\n\nlet result = '';\n\n// é¦–å…ˆæ£€æŸ¥Topicæ˜¯å¦å·²ç»æœ‰ç»“æœï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰\n// å¦‚æœTopicå·²ç»æœ‰ç»“æœï¼Œå³ä½¿stdoutä¸­æœ‰é”™è¯¯ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨Topicç»“æœ\nif (typeof global.vlmTopicSubscribed !== 'undefined' && global.vlmTopicSubscribed[msgId]) {\n    // Topicå·²å°è¯•è·å–ç»“æœï¼Œæ£€æŸ¥æ˜¯å¦æœ‰Topicç»“æœ\n    if (msg.fromTopic === true && msg.result) {\n        // Topicå·²æˆåŠŸè·å–ç»“æœï¼Œç›´æ¥è¿”å›Topicç»“æœï¼Œå¿½ç•¥stdoutä¸­çš„ä»»ä½•é”™è¯¯\n        node.status({ fill: 'green', shape: 'dot', text: 'ä½¿ç”¨Topicç»“æœï¼Œå¿½ç•¥stdouté”™è¯¯' });\n        return msg;\n    }\n}\n\n// æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯æƒ…å†µï¼ˆæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨ã€BPUå†…å­˜åˆ†é…å¤±è´¥ç­‰ï¼‰\nconst errorKeywords = ['[é”™è¯¯]', 'é”™è¯¯', 'Error', 'ERROR', 'fail', 'Fail', 'ä¸å­˜åœ¨', 'not exists', 'Can not open'];\n// BPUç›¸å…³é”™è¯¯å…³é”®è¯\nconst bpuErrorKeywords = ['hbUCPMallocMem', 'hb_mem_alloc', 'hb_mem', 'MallocMem failed', 'allocate', 'allocation failed', 'ret: -400001', 'ret: -16777211', 'ION_ALLOCATOR', 'Fail to allocate', 'Insufficient memory'];\nlet isError = false;\nlet errorLines = [];\nlet errorType = '';\n\n// æ£€æŸ¥BPUå†…å­˜åˆ†é…é”™è¯¯\nfor (const line of lines) {\n    const trimmed = line.trim();\n    for (const keyword of bpuErrorKeywords) {\n        if (trimmed.includes(keyword)) {\n            isError = true;\n            errorType = 'bpu_memory_error';\n            errorLines.push(trimmed);\n            break;\n        }\n    }\n}\n\n// å¦‚æœæ£€æµ‹åˆ°BPUé”™è¯¯ï¼Œå…ˆæ£€æŸ¥Topicæ˜¯å¦å¯èƒ½æœ‰ç»“æœï¼ˆä¼˜å…ˆä½¿ç”¨Topicç»“æœï¼‰\nif (isError && errorType === 'bpu_memory_error') {\n    // æ£€æŸ¥Topicæ˜¯å¦å·²ç»å°è¯•è·å–ç»“æœ\n    const topicTried = typeof global.vlmTopicSubscribed !== 'undefined' && global.vlmTopicSubscribed[msgId];\n    \n    // å¦‚æœTopicè¿˜æ²¡æœ‰å°è¯•ï¼Œç­‰å¾…Topicç»“æœï¼ˆæœ€å¤šç­‰å¾…30ç§’ï¼‰\n    if (!topicTried) {\n        // Topicè¿˜æ²¡æœ‰å°è¯•ï¼Œå¯èƒ½è¿˜åœ¨ç­‰å¾…Topicç»“æœï¼Œæš‚æ—¶ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­ç­‰å¾…\n        // æ£€æŸ¥è¾“å‡ºé•¿åº¦ï¼Œå¦‚æœè¾“å‡ºå¾ˆé•¿ä½†è¿˜æ²¡æœ‰Topicç»“æœï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´\n        const waitTime = output.length > 10000 ? 30000 : 15000; // è¾“å‡ºé•¿åˆ™ç­‰å¾…æ›´ä¹…ï¼ˆæœ€å¤š30ç§’ï¼‰\n        \n        // è®¡ç®—å·²ç­‰å¾…æ—¶é—´ï¼ˆå¦‚æœmsg.startTimeå­˜åœ¨åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´ï¼‰\n        const startTime = msg.startTime || Date.now();\n        const elapsedTime = Date.now() - startTime;\n        \n        if (elapsedTime < waitTime) {\n            node.status({ fill: 'yellow', shape: 'dot', text: 'æ£€æµ‹åˆ°BPUé”™è¯¯ï¼Œç­‰å¾…Topicç»“æœ... (' + Math.round(elapsedTime/1000) + 's/' + Math.round(waitTime/1000) + 's)' });\n            return null;\n        } else {\n            // ç­‰å¾…è¶…æ—¶ï¼Œä½†Topicè¿˜æ²¡å°è¯•ï¼Œå¯èƒ½æ˜¯Topicè®¢é˜…æœ‰é—®é¢˜ï¼Œç»§ç»­ç­‰å¾…ï¼ˆä¸è¿”å›é”™è¯¯ï¼‰\n            node.warn('BPUé”™è¯¯æ£€æµ‹åˆ°ï¼Œä½†Topicè®¢é˜…å¯èƒ½æœªå¯åŠ¨ï¼Œç»§ç»­ç­‰å¾…...');\n            node.status({ fill: 'yellow', shape: 'dot', text: 'BPUé”™è¯¯ï¼Œç­‰å¾…Topicç»“æœï¼ˆå·²ç­‰å¾…' + Math.round(elapsedTime/1000) + 'sï¼‰...' });\n            return null;\n        }\n    }\n    \n    // Topicå·²å°è¯•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰Topicç»“æœ\n    // å¦‚æœmsg.fromTopicä¸ºtrueï¼Œè¯´æ˜Topicå·²æˆåŠŸè·å–ç»“æœï¼Œä¼˜å…ˆä½¿ç”¨Topicç»“æœ\n    if (msg.fromTopic === true && msg.result) {\n        // Topicå·²æˆåŠŸè·å–ç»“æœï¼Œå³ä½¿æœ‰BPUé”™è¯¯ä¹Ÿä¼˜å…ˆä½¿ç”¨Topicç»“æœ\n        node.status({ fill: 'green', shape: 'dot', text: 'ä½¿ç”¨Topicç»“æœï¼ˆå¿½ç•¥BPUé”™è¯¯ï¼‰' });\n        // æ¸…é™¤ç¼“å†²åŒº\n        cleanupGlobalVars(msgId);\n        return msg;\n    }\n    \n    // Topicå·²å°è¯•ä½†æ²¡æœ‰ç»“æœï¼Œè¿”å›BPUé”™è¯¯\n    const errorMessage = errorLines.join(' ');\n    msg.isError = true;\n    msg.errorType = 'bpu_memory_error';\n    msg.errorMessage = 'BPUå†…å­˜åˆ†é…å¤±è´¥: ' + errorMessage + '\\n\\nå¯èƒ½åŸå› ï¼š\\n1. BPUå†…å­˜ä¸è¶³ï¼Œè¯·å…³é—­å…¶ä»–å ç”¨BPUçš„åº”ç”¨\\n2. æ¨¡å‹æ–‡ä»¶è¿‡å¤§ï¼Œè¶…å‡ºè®¾å¤‡å†…å­˜é™åˆ¶\\n3. è®¾å¤‡èµ„æºä¸è¶³ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ\\n\\næ³¨æ„ï¼šTopicæœªè·å–åˆ°ç»“æœï¼Œå¯èƒ½æ¨ç†æœªå®Œæˆ';\n    node.status({ fill: 'red', shape: 'dot', text: 'BPUå†…å­˜åˆ†é…å¤±è´¥' });\n    msg.result = errorMessage;\n    msg.fullOutput = output.substring(Math.max(0, output.length - 2000));\n    \n    // æ¸…é™¤ç¼“å†²åŒº\n    cleanupGlobalVars(msgId);\n    \n    return msg;\n}\n\n// æ£€æŸ¥å…¶ä»–é”™è¯¯\nfor (const line of lines) {\n    const trimmed = line.trim();\n    for (const keyword of errorKeywords) {\n        if (trimmed.includes(keyword)) {\n            isError = true;\n            if (!errorType) {\n                errorType = 'other_error';\n            }\n            errorLines.push(trimmed);\n            break;\n        }\n    }\n}\n\n// å¦‚æœæ˜¯é”™è¯¯æƒ…å†µï¼Œæå–å®Œæ•´çš„é”™è¯¯ä¿¡æ¯\nif (isError && errorLines.length > 0) {\n    // æå–é”™è¯¯ç›¸å…³çš„æ‰€æœ‰è¡Œï¼ˆåŒ…æ‹¬é”™è¯¯ä¿¡æ¯å’Œä¸‹è½½å‘½ä»¤ï¼‰\n    let errorStartIndex = -1;\n    for (let i = 0; i < lines.length; i++) {\n        const trimmed = lines[i].trim();\n        if (trimmed.includes('[é”™è¯¯]') || trimmed.includes('é”™è¯¯') || trimmed.includes('Error')) {\n            errorStartIndex = i;\n            break;\n        }\n    }\n    \n    if (errorStartIndex >= 0) {\n        // æå–ä»é”™è¯¯å¼€å§‹åˆ°æ–‡ä»¶æœ«å°¾çš„æ‰€æœ‰ç›¸å…³è¡Œ\n        const errorSection = lines.slice(errorStartIndex).filter(line => {\n            const trimmed = line.trim();\n            return trimmed.length > 0 && (\n                trimmed.includes('[é”™è¯¯]') ||\n                trimmed.includes('é”™è¯¯') ||\n                trimmed.includes('è¯·å…ˆ') ||\n                trimmed.includes('ä¸‹è½½') ||\n                trimmed.includes('wget') ||\n                trimmed.includes('å¹³å°')\n            );\n        });\n        \n        if (errorSection.length > 0) {\n            result = errorSection.join('\\n');\n            msg.isError = true;\n            msg.errorType = 'model_file_missing';\n            node.status({ fill: 'red', shape: 'dot', text: 'æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨' });\n            msg.result = result;\n            msg.fullOutput = output.substring(Math.max(0, output.length - 2000));\n            \n            // æ¸…é™¤ç¼“å†²åŒº\n            if (global.vlmOutputBuffer && global.vlmOutputBuffer[msgId]) {\n                delete global.vlmOutputBuffer[msgId];\n            }\n            \n            return msg;\n        }\n    }\n}\n\n// ç­–ç•¥1ï¼šæŸ¥æ‰¾[WARN] [llama_cpp_node]ä¹‹åçš„æ¨ç†ç»“æœï¼ˆè¿™æ˜¯VLMçš„æ ‡å‡†è¾“å‡ºæ ¼å¼ï¼‰\n// æ ¼å¼ï¼š[WARN] [timestamp] [llama_cpp_node]:\n//       æ¨ç†ç»“æœæ–‡æœ¬ï¼ˆå¯èƒ½è·¨å¤šè¡Œï¼‰\nlet warnIndex = -1;\nfor (let i = lines.length - 1; i >= 0; i--) {\n    const line = lines[i].trim();\n    // æŸ¥æ‰¾åŒ…å«[WARN]å’Œ[llama_cpp_node]çš„è¡Œ\n    if (line.includes('[WARN]') && line.includes('[llama_cpp_node]')) {\n        warnIndex = i;\n        break;\n    }\n}\n\nif (warnIndex >= 0) {\n    // ä»WARNè¡Œä¹‹åå¼€å§‹æŸ¥æ‰¾æ¨ç†ç»“æœ\n    let resultLines = [];\n    for (let i = warnIndex + 1; i < lines.length; i++) {\n        const line = lines[i].trim();\n        \n        // è·³è¿‡ç©ºè¡Œ\n        if (line.length === 0) continue;\n        \n        // å¦‚æœé‡åˆ°ä¸‹ä¸€ä¸ªæ—¥å¿—æ ‡è®°ï¼ˆå¦‚[INFO], [WARN], [ERROR]ï¼‰ï¼Œåœæ­¢\n        if (line.match(/^\\[INFO\\]|^\\[WARN\\]|^\\[ERROR\\]|^\\[DEBUG\\]/)) {\n            break;\n        }\n        \n        // è·³è¿‡æ˜æ˜¾çš„æ—¥å¿—è¡Œï¼ˆä½†ä¸è·³è¿‡WARNè¡Œæœ¬èº«ï¼Œå› ä¸ºç»“æœåœ¨å®ƒåé¢ï¼‰\n        let isLogLine = false;\n        for (const keyword of logKeywords) {\n            // å¯¹äºWARNä¹‹åçš„æ–‡æœ¬ï¼Œæ›´å®½æ¾åœ°åˆ¤æ–­\n            if (keyword !== 'WARN' && line.includes(keyword)) {\n                isLogLine = true;\n                break;\n            }\n        }\n        \n        // è·³è¿‡æ—¶é—´æˆ³ã€è¿›åº¦æ¡ç­‰\n        if (line.match(/^\\d+\\.\\d+.*$/)) continue; // æ—¶é—´æˆ³\n        if (line.match(/^\\s*\\d+[KM]\\s+[\\.]+\\s+\\d+%\\s+\\d+[KM]\\s+\\d+[ms]/)) continue; // wgetè¿›åº¦\n        if (line.match(/\\[UCPT\\]/i) || line.match(/UCPT.*log/i) || line.match(/log level/i)) continue;\n        \n        // æ£€æŸ¥æ˜¯å¦æ˜¯BPUé”™è¯¯ï¼ˆä¸åº”è¯¥è¢«è¯†åˆ«ä¸ºç»“æœï¼‰\n        let isBpuError = false;\n        for (const keyword of bpuErrorKeywords) {\n            if (line.includes(keyword)) {\n                isBpuError = true;\n                break;\n            }\n        }\n        \n        // å¦‚æœåŒ…å«ä¸­æ–‡æˆ–è¾ƒé•¿çš„è‹±æ–‡ï¼Œä¸”ä¸æ˜¯æ—¥å¿—è¡Œæˆ–BPUé”™è¯¯ï¼Œæ”¶é›†ä¸ºç»“æœçš„ä¸€éƒ¨åˆ†\n        const hasChinese = /[\\u4e00-\\u9fa5]/.test(line);\n        const hasEnglish = /[a-zA-Z]{4,}/.test(line);\n        \n        if (!isLogLine && !isBpuError && (hasChinese || (hasEnglish && line.length > 10))) {\n            resultLines.push(line);\n        }\n    }\n    \n    if (resultLines.length > 0) {\n        // åˆå¹¶å¤šè¡Œç»“æœï¼Œæ¸…ç†</s>ç­‰æ ‡è®°\n        result = resultLines.join(' ').replace(/<\\/s>/g, '').trim();\n        // å¦‚æœç»“æœé•¿åº¦è¶³å¤Ÿï¼Œç«‹å³è¿”å›ï¼Œè·³è¿‡åç»­ç­–ç•¥\n        if (result.length >= 10) {\n            // æ¸…ç†ç»“æœï¼šå»é™¤å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œ\n            result = result.replace(/\\s+/g, ' ').trim();\n            \n            // æ‰¾åˆ°æœ‰æ•ˆç»“æœï¼Œä¿å­˜å¹¶æ¸…é™¤ç¼“å†²åŒº\n            msg.result = result;\n            msg.fullOutput = output.substring(Math.max(0, output.length - 2000));\n            \n            // ç«‹å³æ¸…é™¤ç¼“å†²åŒºï¼ˆæ‰¾åˆ°ç»“æœåç«‹å³æ¸…é™¤ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼‰\n            if (global.vlmOutputBuffer && global.vlmOutputBuffer[msgId]) {\n                delete global.vlmOutputBuffer[msgId];\n            }\n            \n            node.status({ fill: 'green', shape: 'dot', text: 'âœ… æ¨ç†å®Œæˆï¼æ­£åœ¨è§£æç»“æœ...' });\n            return msg;\n        }\n    }\n}\n\n// å¦‚æœç­–ç•¥1æ²¡æ‰¾åˆ°ç»“æœï¼Œä½¿ç”¨åŸæ¥çš„ç­–ç•¥1ï¼ˆä»åå¾€å‰æŸ¥æ‰¾ï¼‰\nif (!result || result.length < 10) {\n    for (let i = lines.length - 1; i >= 0; i--) {\n        const line = lines[i].trim();\n        if (line.length < 10) continue;\n        \n        // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¥å¿—è¡Œ\n        let isLogLine = false;\n        for (const keyword of logKeywords) {\n            if (line.includes(keyword)) {\n                isLogLine = true;\n                break;\n            }\n        }\n        \n        // è·³è¿‡æ˜æ˜¾çš„æ—¥å¿—å’Œç³»ç»Ÿä¿¡æ¯\n        if (isLogLine) continue;\n        if (line.match(/^\\[.*\\]$/)) continue; // [xxx]æ ¼å¼ï¼ŒåŒ…æ‹¬[UCPT]\n        if (line.match(/^\\d+\\.\\d+.*$/)) continue; // æ•°å­—å¼€å¤´çš„æ—¶é—´æˆ³ç­‰\n        if (line.match(/^\\s*\\d+[KM]\\s+[\\.]+\\s+\\d+%\\s+\\d+[KM]\\s+\\d+[ms]/)) continue; // wgetè¿›åº¦ä¿¡æ¯\n        // æ›´ä¸¥æ ¼åœ°è¿‡æ»¤[UCPT]ç›¸å…³æ—¥å¿—\n        if (line.match(/\\[UCPT\\]/i) || line.match(/UCPT.*log/i) || line.match(/log level/i)) continue;\n        \n        // æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ„ä¹‰çš„å†…å®¹\n        const hasChinese = /[\\u4e00-\\u9fa5]/.test(line);\n        const hasEnglish = /[a-zA-Z]{4,}/.test(line);\n        \n        // æ£€æŸ¥æ˜¯å¦æ˜¯å¯åŠ¨ä¿¡æ¯æˆ–echoè¾“å‡ºï¼ˆä¸åº”è¯¥è¢«è¯†åˆ«ä¸ºç»“æœï¼‰\n        let isStartInfo = false;\n        for (const pattern of startInfoPatterns) {\n            if (pattern.test(line)) {\n                isStartInfo = true;\n                break;\n            }\n        }\n        \n        // æ£€æŸ¥æ˜¯å¦æ˜¯echoè¾“å‡ºæ ¼å¼ï¼ˆå¦‚å›¾ç‰‡æ–‡ä»¶æç¤ºæˆ–æç¤ºè¯æç¤ºï¼‰\n        // ä¸¥æ ¼è¿‡æ»¤ï¼šä»»ä½•åŒ…å«å†’å·ç©ºæ ¼åè·Ÿè·¯å¾„çš„è¡Œéƒ½å¯èƒ½æ˜¯echoè¾“å‡º\n        if (!isStartInfo && (\n            line.match(/^(å›¾ç‰‡æ–‡ä»¶|æç¤ºè¯|æ¨¡å‹æ–‡ä»¶|è®¾å¤‡ä¿¡æ¯|å¹³å°|å·¥ä½œç›®å½•|æ£€æµ‹åˆ°å¹³å°|æ£€æŸ¥æ¨¡å‹æ–‡ä»¶|å¯åŠ¨VLMæ¨ç†):/i) || \n            line.match(/.*:\\s*\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i) ||\n            line.match(/^echo\\s+[\"'].*[\"']/i) || // echoå‘½ä»¤æ ¼å¼\n            (line.includes(':') && line.match(/\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i)) // åŒ…å«è·¯å¾„çš„æ–‡ä»¶å\n        )) {\n            isStartInfo = true;\n        }\n        \n        // æ£€æŸ¥æ˜¯å¦æ˜¯BPUé”™è¯¯ï¼ˆä¸åº”è¯¥è¢«è¯†åˆ«ä¸ºç»“æœï¼‰\n        let isBpuError = false;\n        for (const keyword of bpuErrorKeywords) {\n            if (line.includes(keyword)) {\n                isBpuError = true;\n                break;\n            }\n        }\n        \n        // å¦‚æœåŒ…å«ä¸­æ–‡æˆ–è¾ƒé•¿çš„è‹±æ–‡ï¼Œä¸”ä¸æ˜¯å¯åŠ¨ä¿¡æ¯ã€echoè¾“å‡ºæˆ–BPUé”™è¯¯ï¼Œå¯èƒ½æ˜¯ç»“æœ\n        if (!isStartInfo && !isBpuError && (hasChinese || (hasEnglish && line.length > 15))) {\n            result = line;\n            break;\n        }\n    }\n}\n\n// ç­–ç•¥2ï¼šå¦‚æœæ²¡æ‰¾åˆ°ï¼ŒæŸ¥æ‰¾å¯èƒ½åŒ…å«æ¨ç†ç»“æœçš„å¤šè¡Œæ–‡æœ¬å—\nif (!result || result.length < 10) {\n    let candidateLines = [];\n    // æ£€æŸ¥æœ€å30è¡Œ\n    for (let i = lines.length - 1; i >= Math.max(0, lines.length - 30); i--) {\n        const line = lines[i].trim();\n        if (line.length < 10) continue;\n        \n        let isLogLine = false;\n        for (const keyword of logKeywords) {\n            if (line.includes(keyword)) {\n                isLogLine = true;\n                break;\n            }\n        }\n        \n        if (!isLogLine && !line.match(/^\\[.*\\]$/) && !line.match(/^\\d+\\.\\d+/)) {\n            candidateLines.unshift(line);\n        }\n    }\n    \n    if (candidateLines.length > 0) {\n        // åˆå¹¶å€™é€‰è¡Œï¼Œä½†é™åˆ¶é•¿åº¦\n        result = candidateLines.join(' ').substring(0, 800);\n    }\n}\n\n// ç­–ç•¥3ï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…å«æ¨ç†ç»“æœçš„ç‰¹å¾\nif (!result || result.length < 10) {\n    // æŸ¥æ‰¾åŒ…å«ä¸­æ–‡å­—ç¬¦æˆ–è¾ƒé•¿è‹±æ–‡æ–‡æœ¬çš„éƒ¨åˆ†ï¼ˆé™ä½æœ€å°é•¿åº¦è¦æ±‚ï¼‰\n    const chineseMatch = output.match(/[\\u4e00-\\u9fa5]{3,}[^\\n]*/g);\n    if (chineseMatch && chineseMatch.length > 0) {\n        // è¿‡æ»¤æ‰å¯åŠ¨ä¿¡æ¯ï¼Œå–æœ€åä¸€ä¸ªéå¯åŠ¨ä¿¡æ¯çš„åŒ¹é…\n        const filteredMatches = chineseMatch.filter(match => {\n            const trimmed = match.trim();\n            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯åŠ¨ä¿¡æ¯æˆ–echoè¾“å‡º\n            for (const pattern of startInfoPatterns) {\n                if (pattern.test(trimmed)) {\n                    return false;\n                }\n            }\n            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯åŠ¨ä¿¡æ¯å…³é”®è¯\n            if (trimmed.includes('å¯èƒ½éœ€è¦') && trimmed.includes('è¯·è€å¿ƒç­‰å¾…')) {\n                return false;\n            }\n            // æ£€æŸ¥æ˜¯å¦æ˜¯echoè¾“å‡ºæ ¼å¼\n            if (trimmed.match(/^(å›¾ç‰‡æ–‡ä»¶|æç¤ºè¯|æ¨¡å‹æ–‡ä»¶|è®¾å¤‡ä¿¡æ¯|å¹³å°|å·¥ä½œç›®å½•|æ£€æµ‹åˆ°å¹³å°):/i) || \n                trimmed.match(/.*:\\s*\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i)) {\n                return false;\n            }\n            return true;\n        });\n        \n        if (filteredMatches.length > 0) {\n            // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆé€šå¸¸æ˜¯æœ€æ–°çš„ç»“æœï¼‰\n            result = filteredMatches[filteredMatches.length - 1].trim();\n            // æ¸…ç†ï¼šå»é™¤å¯èƒ½çš„æ—¥å¿—å‰ç¼€\n            result = result.replace(/^.*?([\\u4e00-\\u9fa5])/, '$1');\n        }\n    }\n    \n    // å¦‚æœä¸­æ–‡åŒ¹é…å¤±è´¥ï¼Œå°è¯•åŒ¹é…è‹±æ–‡æ–‡æœ¬\n    if (!result || result.length < 10) {\n        const englishMatch = output.match(/[a-zA-Z]{10,}[^\\n]*/g);\n        if (englishMatch && englishMatch.length > 0) {\n            // è¿‡æ»¤æ‰æ˜æ˜¾çš„æ—¥å¿—è¡Œ\n            const filtered = englishMatch.filter(line => {\n                const trimmed = line.trim();\n                return !trimmed.match(/^\\[.*\\]$/) && \n                       !trimmed.includes('INFO') && \n                       !trimmed.includes('WARN') && \n                       !trimmed.includes('ERROR') &&\n                       !trimmed.includes('DEBUG') &&\n                       !trimmed.includes('UCPT') &&\n                       !trimmed.includes('log level') &&\n                       !trimmed.includes('BPU_PLAT') &&\n                       !trimmed.includes('BPU Platform Version') &&\n                       trimmed.length > 15;\n            });\n            \n            if (filtered.length > 0) {\n                // å–æœ€åä¸€ä¸ªåŒ¹é…\n                result = filtered[filtered.length - 1].trim();\n            }\n        }\n    }\n}\n\n// ç­–ç•¥4ï¼šå¦‚æœè¾“å‡ºçœ‹èµ·æ¥è¿˜åœ¨è¿›è¡Œä¸­ï¼ˆåŒ…å«å¯åŠ¨ä¿¡æ¯ä½†æ²¡æœ‰ç»“æœï¼‰ï¼Œç»§ç»­ç­‰å¾…\nconst hasStartInfo = output.includes('å¼€å§‹') || output.includes('å¯åŠ¨') || output.includes('=== å¼€å§‹');\nconst hasResult = result && result.length >= 10 && !result.match(/^\\[.*\\]$/);\n\n// æ£€æŸ¥è¾“å‡ºæ˜¯å¦åªåŒ…å«å¯åŠ¨ä¿¡æ¯ï¼ˆå¯èƒ½è¾“å‡ºè¢«æˆªæ–­ï¼‰\nconst onlyStartInfo = hasStartInfo && output.includes('å¯èƒ½éœ€è¦10-30ç§’') && !output.includes('llamacpp_node') && output.length < 1000;\nif (onlyStartInfo && !hasResult) {\n    node.status({ fill: 'yellow', shape: 'dot', text: 'â³ VLMæ­£åœ¨åˆå§‹åŒ–ï¼Œé¢„è®¡éœ€è¦10-30ç§’...' });\n    return null;\n}\n\n// æ£€æŸ¥æ˜¯å¦åŒ…å«ros2å‘½ä»¤çš„è¾“å‡ºï¼ˆè¯´æ˜å‘½ä»¤å·²ç»å¼€å§‹æ‰§è¡Œï¼‰\nconst hasRos2Output = output.includes('ros2') || output.includes('hobot_llamacpp') || output.includes('llamacpp_node');\n\n// å¦‚æœå‘½ä»¤å·²ç»å¼€å§‹æ‰§è¡Œä½†è¿˜æ²¡æœ‰ç»“æœï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„åœ¨æ¨ç†ä¸­\nif (hasStartInfo && !hasResult) {\n    // å¦‚æœè¾“å‡ºå·²ç»å¾ˆé•¿ï¼ˆ>5000å­—ç¬¦ï¼‰ä½†ä»ç„¶æ²¡æœ‰ç»“æœï¼Œå°è¯•æ›´å®½æ¾çš„è§£æç­–ç•¥\n    if (output.length > 5000) {\n        // å°è¯•æå–æ‰€æœ‰éæ—¥å¿—è¡Œ\n        let allNonLogLines = [];\n        for (let i = lines.length - 1; i >= Math.max(0, lines.length - 50); i--) {\n            const line = lines[i].trim();\n            if (line.length < 5) continue;\n            \n            // è·³è¿‡æ˜æ˜¾çš„æ—¥å¿—\n            let isLogLine = false;\n            for (const keyword of logKeywords) {\n                if (line.includes(keyword)) {\n                    isLogLine = true;\n                    break;\n                }\n            }\n            \n            if (!isLogLine && \n                !line.match(/^\\[.*\\]$/) && \n                !line.match(/^\\d+\\.\\d+.*$/) && \n                !line.match(/^\\s*\\d+[KM]\\s+[\\.]+\\s+\\d+%\\s+\\d+[KM]\\s+\\d+[ms]/) &&\n                !line.match(/\\[UCPT\\]/i) &&\n                !line.match(/log level/i)) {\n                allNonLogLines.unshift(line);\n            }\n        }\n        \n        // å¦‚æœæ‰¾åˆ°äº†ä¸€äº›éæ—¥å¿—è¡Œï¼Œå°è¯•åˆå¹¶å®ƒä»¬ä½œä¸ºç»“æœ\n        if (allNonLogLines.length > 0) {\n            const mergedResult = allNonLogLines.join(' ').substring(0, 1000);\n            // æ£€æŸ¥åˆå¹¶åçš„ç»“æœæ˜¯å¦åŒ…å«æœ‰æ„ä¹‰çš„å†…å®¹\n            const hasChinese = /[\\u4e00-\\u9fa5]/.test(mergedResult);\n            const hasEnglish = /[a-zA-Z]{4,}/.test(mergedResult);\n            \n            if (hasChinese || (hasEnglish && mergedResult.length > 20)) {\n                result = mergedResult;\n            }\n        }\n    }\n    \n    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ç»“æœï¼Œä½†è¾“å‡ºå·²ç»å¾ˆé•¿ï¼Œå¯èƒ½è¿˜åœ¨æ¨ç†ä¸­\n    if (!result || result.length < 10) {\n        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨ç†ç›¸å…³çš„å…³é”®è¯ï¼ˆè¯´æ˜æ¨ç†æ­£åœ¨è¿›è¡Œï¼‰\n        const hasInferenceKeywords = output.includes('prefill') || \n                                     output.includes('eval time') || \n                                     output.includes('image encoder') ||\n                                     output.includes('token') ||\n                                     output.includes('ç”Ÿæˆ') ||\n                                     output.includes('æ¨ç†');\n        \n        if (hasInferenceKeywords || hasRos2Output) {\n            // å¯èƒ½è¿˜åœ¨æ¨ç†ä¸­ï¼Œç­‰å¾…æ›´å¤šè¾“å‡º\n            const elapsedSeconds = Math.floor((Date.now() - (msg.startTime || Date.now())) / 1000);\n            node.status({ fill: 'blue', shape: 'dot', text: 'ğŸ¤– AIæ­£åœ¨åˆ†æå›¾ç‰‡ä¸­... (å·²ç”¨æ—¶: ' + elapsedSeconds + 'ç§’)' });\n            return null;\n        } else if (output.length > 10000) {\n            // è¾“å‡ºå¾ˆé•¿ä½†æ²¡æœ‰æ¨ç†å…³é”®è¯ï¼Œå¯èƒ½æ˜¯è§£æé—®é¢˜ï¼Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯\n            const debugOutput = output.substring(Math.max(0, output.length - 1000));\n            node.warn('VLMè¾“å‡ºå¾ˆé•¿ä½†æœªæ‰¾åˆ°ç»“æœï¼Œæœ€å1000å­—ç¬¦: ' + debugOutput);\n            node.status({ fill: 'orange', shape: 'dot', text: 'è¾“å‡ºè¿‡é•¿ï¼Œè¯·æ£€æŸ¥è°ƒè¯•ä¿¡æ¯ (' + output.length + ' chars)' });\n        }\n    }\n}\n\n// æ¸…ç†ç»“æœï¼šå»é™¤å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œ\nif (result) {\n    result = result.replace(/\\s+/g, ' ').trim();\n}\n\n// æ£€æŸ¥ç»“æœæ˜¯å¦æ˜¯å¯åŠ¨ä¿¡æ¯ã€echoè¾“å‡ºæˆ–BPUé”™è¯¯ï¼ˆä¸åº”è¯¥è¢«è¯†åˆ«ä¸ºç»“æœï¼‰\nif (result) {\n    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯BPUå†…å­˜åˆ†é…é”™è¯¯\n    for (const keyword of bpuErrorKeywords) {\n        if (result.includes(keyword)) {\n            // è¿™æ˜¯BPUé”™è¯¯ï¼Œä¸æ˜¯æ¨ç†ç»“æœ\n            const errorMessage = result;\n            msg.isError = true;\n            msg.errorType = 'bpu_memory_error';\n            msg.errorMessage = 'BPUå†…å­˜åˆ†é…å¤±è´¥: ' + errorMessage + '\\n\\nå¯èƒ½åŸå› ï¼š\\n1. BPUå†…å­˜ä¸è¶³ï¼Œè¯·å…³é—­å…¶ä»–å ç”¨BPUçš„åº”ç”¨\\n2. æ¨¡å‹æ–‡ä»¶è¿‡å¤§ï¼Œè¶…å‡ºè®¾å¤‡å†…å­˜é™åˆ¶\\n3. è®¾å¤‡èµ„æºä¸è¶³ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ';\n            node.status({ fill: 'red', shape: 'dot', text: 'BPUå†…å­˜åˆ†é…å¤±è´¥' });\n            msg.result = errorMessage;\n            msg.fullOutput = output.substring(Math.max(0, output.length - 2000));\n            \n            // æ¸…é™¤ç¼“å†²åŒº\n            if (global.vlmOutputBuffer && global.vlmOutputBuffer[msgId]) {\n                delete global.vlmOutputBuffer[msgId];\n            }\n            \n            return msg;\n        }\n    }\n    \n    // æ£€æŸ¥å¯åŠ¨ä¿¡æ¯æ¨¡å¼\n    for (const pattern of startInfoPatterns) {\n        if (pattern.test(result)) {\n            // è¿™æ˜¯å¯åŠ¨ä¿¡æ¯æˆ–echoè¾“å‡ºï¼Œä¸æ˜¯ç»“æœï¼Œç»§ç»­ç­‰å¾…\n            node.status({ fill: 'yellow', shape: 'dot', text: 'ç­‰å¾…æ¨ç†ç»“æœ... (' + output.length + ' chars)' });\n            return null;\n        }\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯åŠ¨ä¿¡æ¯å…³é”®è¯\n    if (result.includes('å¯èƒ½éœ€è¦') && result.includes('è¯·è€å¿ƒç­‰å¾…')) {\n        node.status({ fill: 'yellow', shape: 'dot', text: 'ç­‰å¾…æ¨ç†ç»“æœ... (' + output.length + ' chars)' });\n        return null;\n    }\n    \n    // æ£€æŸ¥æ˜¯å¦æ˜¯echoè¾“å‡ºæ ¼å¼ï¼ˆå¦‚å›¾ç‰‡æ–‡ä»¶æç¤ºæˆ–æç¤ºè¯æç¤ºï¼‰\n    // ä¸¥æ ¼è¿‡æ»¤ï¼šä»»ä½•åŒ…å«å†’å·ç©ºæ ¼åè·Ÿè·¯å¾„çš„è¡Œéƒ½å¯èƒ½æ˜¯echoè¾“å‡º\n    if (result.match(/^(å›¾ç‰‡æ–‡ä»¶|æç¤ºè¯|æ¨¡å‹æ–‡ä»¶|è®¾å¤‡ä¿¡æ¯|å¹³å°|å·¥ä½œç›®å½•|æ£€æµ‹åˆ°å¹³å°|æ£€æŸ¥æ¨¡å‹æ–‡ä»¶|å¯åŠ¨VLMæ¨ç†):/i) || \n        result.match(/.*:\\s*\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i) ||\n        result.match(/.*image-\\d{8}-\\d{6}\\.(jpg|jpeg)/i) ||\n        result.match(/^echo\\s+[\"'].*[\"']/i) || // echoå‘½ä»¤æ ¼å¼\n        (result.includes(':') && result.match(/\\/.*\\.(jpg|jpeg|png|bin|hbm|gguf)/i))) { // åŒ…å«è·¯å¾„çš„æ–‡ä»¶å\n        // è¿™æ˜¯echoè¾“å‡ºï¼Œä¸æ˜¯ç»“æœï¼Œç»§ç»­ç­‰å¾…\n        node.status({ fill: 'yellow', shape: 'dot', text: 'è¿‡æ»¤echoè¾“å‡ºï¼Œç­‰å¾…æ¨ç†ç»“æœ... (' + output.length + ' chars)' });\n        return null;\n    }\n}\n\n// æ”¾å®½ç»“æœè¯†åˆ«æ¡ä»¶ï¼šå¦‚æœç»“æœåŒ…å«ä¸­æ–‡æˆ–è¾ƒé•¿çš„è‹±æ–‡ï¼Œå³ä½¿çŸ­ä¸€äº›ä¹Ÿæ¥å—\nconst hasChinese = result && /[\\u4e00-\\u9fa5]/.test(result);\nconst hasEnglish = result && /[a-zA-Z]{4,}/.test(result);\nconst minLength = hasChinese ? 8 : (hasEnglish ? 12 : 15);\n\n// å¦‚æœç»“æœå¤ªçŸ­æˆ–çœ‹èµ·æ¥ä¸åƒæ¨ç†ç»“æœï¼Œç»§ç»­ç­‰å¾…\n// ç‰¹åˆ«æ£€æŸ¥æ˜¯å¦æ˜¯æ—¥å¿—ä¿¡æ¯æˆ–å¯åŠ¨ä¿¡æ¯\nif (!result || result.length < minLength || result.match(/^\\[.*\\]$/) || result.match(/\\[UCPT\\]/i) || result.match(/log level/i)) {\n    // å¦‚æœè¾“å‡ºå·²ç»å¾ˆé•¿ï¼ˆ>50000å­—ç¬¦ï¼‰ï¼Œå¯èƒ½æ˜¯è§£æé€»è¾‘æœ‰é—®é¢˜æˆ–å‘½ä»¤å¡ä½ï¼Œè¿”å›é”™è¯¯\n    if (output.length > 50000) {\n        // è¾“å‡ºå¤ªé•¿ï¼Œå¯èƒ½å‘½ä»¤å¡ä½æˆ–è¾“å‡ºå¼‚å¸¸\n        const debugOutput = output.substring(Math.max(0, output.length - 2000));\n        node.error('VLMè¾“å‡ºè¿‡é•¿ï¼ˆ' + output.length + 'å­—ç¬¦ï¼‰ï¼Œå¯èƒ½å‘½ä»¤å¡ä½æˆ–è¾“å‡ºå¼‚å¸¸ã€‚æœ€å2000å­—ç¬¦: ' + debugOutput);\n        node.status({ fill: 'red', shape: 'dot', text: 'è¾“å‡ºå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å‘½ä»¤æ‰§è¡Œ' });\n        \n        msg.isError = true;\n        msg.errorType = 'output_too_long';\n        msg.errorMessage = 'VLMè¾“å‡ºè¿‡é•¿ï¼ˆ' + output.length + 'å­—ç¬¦ï¼‰ï¼Œå¯èƒ½å‘½ä»¤å¡ä½æˆ–è¾“å‡ºå¼‚å¸¸ã€‚è¯·æ£€æŸ¥ï¼š\\n1. å‘½ä»¤æ˜¯å¦æ­£å¸¸æ‰§è¡Œ\\n2. æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨\\n3. è®¾å¤‡èµ„æºæ˜¯å¦å……è¶³\\n4. æŸ¥çœ‹Debugé¢æ¿è·å–æ›´å¤šä¿¡æ¯';\n        msg.fullOutput = debugOutput;\n        \n        // æ¸…é™¤ç¼“å†²åŒº\n        cleanupGlobalVars(msgId);\n        \n        return msg;\n    } else if (output.length > 10000) {\n        // è¾“å‡ºè¾ƒé•¿ï¼Œå¯èƒ½æ˜¯è§£æé—®é¢˜ï¼Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯ä½†ç»§ç»­ç­‰å¾…\n        const debugOutput = output.substring(Math.max(0, output.length - 1000));\n        node.warn('VLMè¾“å‡ºè¾ƒé•¿ä½†æœªæ‰¾åˆ°ç»“æœï¼ˆ' + output.length + 'å­—ç¬¦ï¼‰ï¼Œæœ€å1000å­—ç¬¦: ' + debugOutput);\n        node.status({ fill: 'orange', shape: 'dot', text: 'è¾“å‡ºè¾ƒé•¿ï¼Œç­‰å¾…ç»“æœ... (' + output.length + ' chars)' });\n    } else {\n        node.status({ fill: 'yellow', shape: 'dot', text: 'ç­‰å¾…å®Œæ•´è¾“å‡º... (' + output.length + ' chars)' });\n    }\n    return null;\n}\n\n// æ‰¾åˆ°æœ‰æ•ˆç»“æœï¼Œä¿å­˜å¹¶æ¸…é™¤ç¼“å†²åŒº\nmsg.result = result;\nmsg.fullOutput = output.substring(Math.max(0, output.length - 2000)); // ä¿å­˜æœ€å2000å­—ç¬¦ç”¨äºè°ƒè¯•\n\n// æ¸…é™¤ç´¯ç§¯çš„è¾“å‡ºï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰æ¸…é™¤ï¼Œè¿™é‡Œæ¸…é™¤ï¼‰\n// æ³¨æ„ï¼šç¼“å†²åŒºå·²åœ¨æ‰¾åˆ°ç»“æœæ—¶ç«‹å³æ¸…é™¤ï¼Œè¿™é‡Œåªå¤„ç†æœªæ‰¾åˆ°ç»“æœçš„æƒ…å†µ\nif (global.vlmOutputBuffer && global.vlmOutputBuffer[msgId] && !msg.result) {\n    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æœï¼Œå»¶è¿Ÿæ¸…é™¤ï¼ˆå¯èƒ½è¿˜åœ¨å¤„ç†ä¸­ï¼‰\n    setTimeout(() => {\n        cleanupGlobalVars(msgId);\n    }, 5000);\n}\n\nnode.status({ fill: 'green', shape: 'dot', text: 'âœ… æ¨ç†å®Œæˆï¼ç»“æœå·²è·å–' });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 300,
        "wires": [
            [
                "debug_vlm_result"
            ]
        ]
    },
    {
        "id": "debug_vlm_result",
        "type": "debug",
        "z": "vlm_tab",
        "name": "VLMæ¨ç†ç»“æœ",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "result",
        "targetType": "msg",
        "statusVal": "result",
        "statusType": "auto",
        "x": 1340,
        "y": 320,
        "wires": []
    },
    {
        "id": "comment_feedback_section",
        "type": "comment",
        "z": "vlm_tab",
        "name": "ğŸ–¼ï¸ æœ¬åœ°å›¾ç‰‡å›çŒæ¨¡å¼",
        "info": "ä½¿ç”¨æœ¬åœ°å›¾ç‰‡è¿›è¡ŒVLMæ¨ç†\n\n**ä½¿ç”¨æ–¹æ³•ï¼š**\n1. ç›´æ¥ç‚¹å‡»æŒ‰é’®ï¼šä½¿ç”¨é»˜è®¤å›¾ç‰‡ `config/image2.jpg`\n2. è‡ªå®šä¹‰è·¯å¾„ï¼šåœ¨injectèŠ‚ç‚¹ä¸­è®¾ç½® `msg.payload` ä¸ºå›¾ç‰‡è·¯å¾„\n   - ç»å¯¹è·¯å¾„ï¼š`/home/sunrise/vlm_model/my_image.jpg`\n   - ç›¸å¯¹è·¯å¾„ï¼š`config/image2.jpg`ï¼ˆç›¸å¯¹äº ~/vlm_modelï¼‰\n   - æ”¯æŒ ~ è·¯å¾„ï¼š`~/vlm_model/my_image.jpg`",
        "x": 150,
        "y": 340,
        "wires": []
    },
    {
        "id": "inject_feedback_start",
        "type": "inject",
        "z": "vlm_tab",
        "name": "å¯åŠ¨æœ¬åœ°å›¾ç‰‡VLMæ¨ç†",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "topic": "",
        "payload": "config/image2.jpg",
        "payloadType": "str",
        "x": 140,
        "y": 400,
        "wires": [
            [
                "function_prepare_feedback"
            ]
        ]
    },
    {
        "id": "function_prepare_feedback",
        "type": "function",
        "z": "vlm_tab",
        "name": "å‡†å¤‡å›çŒå›¾ç‰‡",
        "func": "// å‡†å¤‡å›çŒå›¾ç‰‡è·¯å¾„\n// æ”¯æŒè‡ªå®šä¹‰è·¯å¾„ï¼šå¦‚æœmsg.payloadåŒ…å«è·¯å¾„åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„\nconst saveDir = os.homedir() + '/vlm_model';\nconst defaultImage = 'config/image2.jpg'; // é»˜è®¤å›¾ç‰‡è·¯å¾„\n\n// ä»msg.payloadè·å–ç”¨æˆ·æŒ‡å®šçš„å›¾ç‰‡è·¯å¾„ï¼ˆå¦‚æœæä¾›ï¼‰\nlet userImagePath = null;\nif (msg.payload && typeof msg.payload === 'string' && msg.payload.trim() !== '') {\n    userImagePath = msg.payload.trim();\n}\n\n// ç¡®å®šè¦ä½¿ç”¨çš„å›¾ç‰‡è·¯å¾„\nlet imagePath = userImagePath || defaultImage;\n\n// ç¡®ä¿ç›®å½•å­˜åœ¨\nif (!fs.existsSync(saveDir)) {\n    fs.mkdirSync(saveDir, { recursive: true });\n}\n\n// æ„å»ºç»å¯¹è·¯å¾„\nlet absolutePath;\nif (path.isAbsolute(imagePath)) {\n    // å¦‚æœå·²ç»æ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨\n    absolutePath = imagePath;\n} else if (imagePath.startsWith('~')) {\n    // æ”¯æŒ ~ å¼€å¤´çš„è·¯å¾„\n    absolutePath = imagePath.replace(/^~/, os.homedir());\n} else {\n    // ç›¸å¯¹è·¯å¾„ï¼Œç›¸å¯¹äºsaveDir\n    absolutePath = path.join(saveDir, imagePath);\n}\n\n// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\nif (fs.existsSync(absolutePath)) {\n    node.status({ fill: 'green', shape: 'dot', text: 'æ‰¾åˆ°å›¾ç‰‡: ' + path.basename(absolutePath) });\n} else {\n    // å¦‚æœç”¨æˆ·æŒ‡å®šçš„è·¯å¾„ä¸å­˜åœ¨ï¼Œå°è¯•é»˜è®¤è·¯å¾„\n    if (userImagePath && userImagePath !== defaultImage) {\n        const defaultAbsolutePath = path.join(saveDir, defaultImage);\n        if (fs.existsSync(defaultAbsolutePath)) {\n            node.warn('æŒ‡å®šçš„å›¾ç‰‡è·¯å¾„ä¸å­˜åœ¨: ' + absolutePath + 'ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„: ' + defaultAbsolutePath);\n            absolutePath = defaultAbsolutePath;\n            node.status({ fill: 'yellow', shape: 'dot', text: 'ä½¿ç”¨é»˜è®¤å›¾ç‰‡' });\n        } else {\n            node.warn('å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ' + absolutePath + 'ï¼Œå°†åœ¨å‘½ä»¤æ‰§è¡Œæ—¶æ£€æŸ¥');\n            node.status({ fill: 'yellow', shape: 'dot', text: 'å›¾ç‰‡è·¯å¾„: ' + absolutePath });\n        }\n    } else {\n        // å°è¯•åœ¨configç›®å½•ä¸­æŸ¥æ‰¾é»˜è®¤å›¾ç‰‡\n        const configPath = path.join(saveDir, 'config', path.basename(imagePath));\n        if (fs.existsSync(configPath)) {\n            absolutePath = configPath;\n            node.status({ fill: 'green', shape: 'dot', text: 'æ‰¾åˆ°å›çŒå›¾ç‰‡' });\n        } else {\n            node.warn('å›çŒå›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ' + absolutePath + 'ï¼Œå°†åœ¨å‘½ä»¤æ‰§è¡Œæ—¶æ£€æŸ¥');\n            node.status({ fill: 'yellow', shape: 'dot', text: 'å›¾ç‰‡è·¯å¾„: ' + absolutePath });\n        }\n    }\n}\n\nmsg.photoDir = saveDir;\nmsg.photoPath = absolutePath;\nmsg.photoFileName = path.basename(absolutePath);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "path",
                "module": "path"
            },
            {
                "var": "os",
                "module": "os"
            }
        ],
        "x": 350,
        "y": 400,
        "wires": [
            [
                "function_build_feedback_cmd"
            ]
        ]
    },
    {
        "id": "function_build_feedback_cmd",
        "type": "function",
        "z": "vlm_tab",
        "name": "æ„å»ºå›çŒå‘½ä»¤",
        "func": "// æ„å»ºå›çŒæ¨¡å¼VLMæ¨ç†å‘½ä»¤\n// æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„æ–¹å¼ï¼šå…ˆsourceç¯å¢ƒï¼Œå¤åˆ¶configï¼Œç„¶åè¿è¡Œros2å‘½ä»¤\nconst photoDir = msg.photoDir || (os.homedir() + '/vlm_model');\nlet photoPath = msg.photoPath || 'config/image2.jpg';\n\n// å¦‚æœphotoPathä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œæ„å»ºç»å¯¹è·¯å¾„\nif (!photoPath.startsWith('/')) {\n    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›¸å¯¹äºphotoDiræ„å»ºç»å¯¹è·¯å¾„\n    photoPath = photoDir + '/' + photoPath;\n}\nconst photoFileName = path.basename(photoPath);\nconst absolutePhotoPath = photoPath;\n\n// è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\nconst modelType = (global.vlmModelType && global.vlmModelType.current) || 'internvl';\nconst modelFile = (global.vlmModelType && global.vlmModelType.modelFile) || 'vit_model_int16_v2.bin';\nconst llmModel = (global.vlmModelType && global.vlmModelType.llmModel) || 'Qwen2.5-0.5B-Instruct-Q4_0.gguf';\nconst modelTypeParam = (global.vlmModelType && global.vlmModelType.modelTypeParam) || '';\n\n// è·å–æç¤ºè¯ï¼ˆä¼˜å…ˆçº§ï¼šmsg.userPrompt > global.get('vlmPrompt') > é»˜è®¤å€¼ï¼‰\nconst userPrompt = (msg.userPrompt && typeof msg.userPrompt === 'string' && msg.userPrompt.trim() !== '')\n    ? msg.userPrompt.trim()\n    : (global.get('vlmPrompt') || 'æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.');\n\n// æ„å»ºå‘½ä»¤\n// æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„æ–¹å¼ï¼šå…ˆsourceç¯å¢ƒï¼Œå¤åˆ¶configï¼Œç„¶åè¿è¡Œros2å‘½ä»¤\n// æ£€æµ‹å¹³å°å¹¶è‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰\n// é¦–å…ˆæ¸…ç†æ—§çš„VLMè¿›ç¨‹ï¼Œé¿å…BPUèµ„æºå†²çª\n// ç„¶åç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯¥ç›®å½•\nlet cmd = 'echo \\\"=== 1. æ¸…ç†æ—§è¿›ç¨‹ ===\\\" && ';\ncmd += 'pkill -f hobot_llamacpp 2>/dev/null || true && ';\ncmd += 'sleep 2 && ';\ncmd += 'echo \\\"=== 2. å‡†å¤‡ç¯å¢ƒ ===\\\" && ';\ncmd += 'mkdir -p ' + photoDir + ' && cd ' + photoDir + ' && ';\ncmd += 'source /opt/tros/humble/setup.bash && ';\ncmd += 'export TROS_DISTRO=${TROS_DISTRO:-humble} && cp -r /opt/tros/${TROS_DISTRO}/lib/hobot_llamacpp/config/ . && ';\ncmd += 'echo \"æ£€æŸ¥æ¨¡å‹æ–‡ä»¶...\" && ';\n\n// æ£€æµ‹å¹³å°ï¼ˆæ”¯æŒ S100, S100P, X5 ç­‰ï¼‰\ncmd += 'echo \"=== å¹³å°æ£€æµ‹ ===\" && ';\ncmd += 'DEVICE_MODEL=$(cat /proc/device-tree/model 2>/dev/null | strings || echo \"\") && ';\ncmd += 'echo \"è®¾å¤‡ä¿¡æ¯: $DEVICE_MODEL\" && ';\ncmd += 'PLATFORM=$(echo \"$DEVICE_MODEL\" | grep -oiE \"(S100|S100P)\" | head -1 || echo \"$DEVICE_MODEL\" | grep -oiE \"X5\" | head -1 || echo \"X5\") && ';\ncmd += 'PLATFORM=$(echo \"$PLATFORM\" | tr \"[:lower:]\" \"[:upper:]\" | sed \"s/S100P/S100/g\") && ';\ncmd += 'echo \"æ£€æµ‹åˆ°å¹³å°: $PLATFORM\" && ';\n\n// æ ¹æ®å¹³å°è®¾ç½®ä¸‹è½½URL\nif (modelType === 'internvl') {\n    cmd += 'if [ \"$PLATFORM\" = \"S100\" ]; then MODEL_URL=\"https://hf-mirror.com/D-Robotics/InternVL2_5-1B-GGUF-BPU/resolve/main/rdks100/vit_model_int16.hbm\"; MODEL_FILE=\"vit_model_int16.hbm\"; else MODEL_URL=\"https://hf-mirror.com/D-Robotics/InternVL2_5-1B-GGUF-BPU/resolve/main/rdkx5/vit_model_int16_v2.bin\"; MODEL_FILE=\"vit_model_int16_v2.bin\"; fi && ';\n} else {\n    // SmolVLM\n    cmd += 'if [ \"$PLATFORM\" = \"S100\" ]; then MODEL_URL=\"https://hf-mirror.com/D-Robotics/SmolVLM2-256M-Video-Instruct-GGUF-BPU/resolve/main/rdks100/SigLip_int16_SmolVLM2_256M_Instruct_S100.hbm\"; MODEL_FILE=\"SigLip_int16_SmolVLM2_256M_Instruct_S100.hbm\"; else MODEL_URL=\"https://hf-mirror.com/D-Robotics/SmolVLM2-256M-Video-Instruct-GGUF-BPU/resolve/main/rdkx5/SigLip_int16_SmolVLM2_256M_Instruct_MLP_C1_UP_X5.bin\"; MODEL_FILE=\"SigLip_int16_SmolVLM2_256M_Instruct_MLP_C1_UP_X5.bin\"; fi && ';\n}\n\n// æ£€æŸ¥å¹¶è‡ªåŠ¨ä¸‹è½½å›¾åƒç¼–ç æ¨¡å‹ï¼ˆä½¿ç”¨shellå˜é‡$MODEL_FILEï¼‰\n// æ³¨æ„ï¼šwgetçš„--show-progressä¼šå°†è¿›åº¦è¾“å‡ºåˆ°stderrï¼Œéœ€è¦é‡å®šå‘åˆ°stdoutä»¥é¿å…è¢«è¯¯åˆ¤ä¸ºé”™è¯¯\ncmd += 'if [ ! -f \"$MODEL_FILE\" ]; then echo \"æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹è‡ªåŠ¨ä¸‹è½½: $MODEL_FILE\" && wget --show-progress \"$MODEL_URL\" -O \"$MODEL_FILE\" 2>&1 && echo \"âœ“ å›¾åƒç¼–ç æ¨¡å‹ä¸‹è½½å®Œæˆ\" || (echo \"âš  æ¨¡å‹æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½\" && exit 1); fi && ';\n// ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆé‡è¦ï¼å¿…é¡»ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰\ncmd += 'ACTUAL_MODEL_FILE=\"' + photoDir + '/$MODEL_FILE\" && ';\n\n// è®¾ç½®LLMæ¨¡å‹URL\nif (modelType === 'internvl') {\n    cmd += 'LLM_URL=\"https://hf-mirror.com/D-Robotics/InternVL2_5-1B-GGUF-BPU/resolve/main/Qwen2.5-0.5B-Instruct-Q4_0.gguf\" && ';\n} else {\n    cmd += 'LLM_URL=\"https://hf-mirror.com/D-Robotics/SmolVLM2-256M-Video-Instruct-GGUF-BPU/resolve/main/SmolVLM2-256M-Video-Instruct-Q8_0.gguf\" && ';\n}\n\n// æ£€æŸ¥å¹¶è‡ªåŠ¨ä¸‹è½½LLMæ¨¡å‹\n// æ³¨æ„ï¼šwgetçš„--show-progressä¼šå°†è¿›åº¦è¾“å‡ºåˆ°stderrï¼Œéœ€è¦é‡å®šå‘åˆ°stdoutä»¥é¿å…è¢«è¯¯åˆ¤ä¸ºé”™è¯¯\ncmd += 'if [ ! -f \"' + llmModel + '\" ]; then echo \"LLMæ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹è‡ªåŠ¨ä¸‹è½½: ' + llmModel + '\" && wget --show-progress \"$LLM_URL\" -O \"' + llmModel + '\" 2>&1 && echo \"âœ“ LLMæ¨¡å‹ä¸‹è½½å®Œæˆ\" || (echo \"âš  LLMæ¨¡å‹æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½\" && exit 1); fi && ';\ncmd += 'echo \"æ¨¡å‹æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œå¯åŠ¨VLMæ¨ç†...\" >&2 && ';\n// è½¬ä¹‰userPromptä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆåŒå¼•å·å’Œåæ–œæ ï¼‰\nconst escapedPrompt = userPrompt.replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/\"/g, '\\\\\"');\ncmd += 'echo \"æç¤ºè¯: ' + escapedPrompt + '\" >&2 && ';\ncmd += 'echo \"å›¾ç‰‡æ–‡ä»¶: ' + absolutePhotoPath + '\" >&2 && ';\n// æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨\ncmd += 'if [ ! -f \"' + absolutePhotoPath + '\" ]; then echo \"[é”™è¯¯] å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ' + absolutePhotoPath + '\" >&2 && exit 1; fi && ';\ncmd += 'echo \"=== å¼€å§‹VLMæ¨ç†ï¼ˆå¯èƒ½éœ€è¦10-30ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼‰===\" >&2 && ';\n// ä½¿ç”¨stdbufç¦ç”¨è¾“å‡ºç¼“å†²ï¼Œç¡®ä¿å®æ—¶è¾“å‡º\n// è½¬ä¹‰å‚æ•°å€¼ä¸­çš„åŒå¼•å·ï¼Œç¡®ä¿shellå‘½ä»¤æ­£ç¡®è§£æ\n// ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿ros2å‘½ä»¤èƒ½æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶å’Œæ¨¡å‹æ–‡ä»¶\ncmd += 'stdbuf -oL -eL ros2 run hobot_llamacpp hobot_llamacpp --ros-args ';\ncmd += '-p feed_type:=0 ';\ncmd += '-p image:=' + absolutePhotoPath + ' ';\ncmd += '-p image_type:=0 ';\ncmd += '-p user_prompt:=\"' + escapedPrompt + '\" ';\ncmd += '-p model_file_name:=$ACTUAL_MODEL_FILE ';\ncmd += '-p llm_model_name:=' + photoDir + '/' + llmModel;\n\n// å¦‚æœæ˜¯SmolVLMï¼Œæ·»åŠ model_typeå‚æ•°\nif (modelTypeParam) {\n    cmd += ' ' + modelTypeParam;\n}\n\nmsg.payload = cmd;\nmsg.modelType = modelType;\nmsg.userPrompt = userPrompt;\nmsg.startTime = Date.now(); // è®°å½•å¼€å§‹æ—¶é—´ï¼Œç”¨äºè®¡ç®—ç­‰å¾…æ—¶é—´\n\nnode.status({ fill: 'blue', shape: 'dot', text: 'å›çŒå‘½ä»¤å·²æ„å»º' });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "path",
                "module": "path"
            },
            {
                "var": "os",
                "module": "os"
            }
        ],
        "x": 550,
        "y": 400,
        "wires": [
            [
                "exec_start_vlm"
            ]
        ]
    },
    {
        "id": "comment_prompt_section",
        "type": "comment",
        "z": "vlm_tab",
        "name": "ğŸ’¬ è‡ªå®šä¹‰æç¤ºè¯",
        "info": "è®¾ç½®VLMæ¨ç†çš„æç¤ºè¯ï¼ˆé»˜è®¤ï¼šæè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.ï¼‰",
        "x": 150,
        "y": 480,
        "wires": []
    },
    {
        "id": "inject_set_prompt_chinese",
        "type": "inject",
        "z": "vlm_tab",
        "name": "è®¾ç½®æç¤ºè¯ï¼ˆä¸­æ–‡ï¼‰",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.",
        "payloadType": "str",
        "x": 140,
        "y": 540,
        "wires": [
            [
                "function_save_prompt"
            ]
        ]
    },
    {
        "id": "inject_set_prompt_english",
        "type": "inject",
        "z": "vlm_tab",
        "name": "è®¾ç½®æç¤ºè¯ï¼ˆè‹±æ–‡ï¼‰",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "Describe the image.",
        "payloadType": "str",
        "x": 140,
        "y": 580,
        "wires": [
            [
                "function_save_prompt"
            ]
        ]
    },
    {
        "id": "function_save_prompt",
        "type": "function",
        "z": "vlm_tab",
        "name": "ä¿å­˜æç¤ºè¯",
        "func": "// ä¿å­˜æç¤ºè¯åˆ°å…¨å±€å˜é‡\nconst promptToSave = (msg.payload && typeof msg.payload === 'string' && msg.payload.trim() !== '') \n    ? msg.payload.trim() \n    : (global.get('vlmPrompt') || 'æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡.');\n\nglobal.set('vlmPrompt', promptToSave);\nnode.status({ fill: 'green', shape: 'dot', text: 'æç¤ºè¯: ' + promptToSave.substring(0, 20) + '...' });\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "comment_control_section",
        "type": "comment",
        "z": "vlm_tab",
        "name": "ğŸ® æ§åˆ¶åŠŸèƒ½",
        "info": "åœæ­¢VLMæœåŠ¡",
        "x": 150,
        "y": 600,
        "wires": []
    },
    {
        "id": "inject_stop",
        "type": "inject",
        "z": "vlm_tab",
        "name": "åœæ­¢VLMæœåŠ¡",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "topic": "",
        "payload": "stop",
        "payloadType": "str",
        "x": 140,
        "y": 660,
        "wires": [
            [
                "exec_stop_all"
            ]
        ]
    },
    {
        "id": "exec_stop_all",
        "type": "exec",
        "z": "vlm_tab",
        "name": "åœæ­¢æœåŠ¡",
        "command": "sudo pkill -9 -f hobot_llamacpp; sudo pkill -9 -f hobot_usb_cam; sudo pkill -9 -f hobot_dosod; sudo pkill -9 -f websocket; sudo pkill -9 -f python3; sudo pkill -9 -f 'ros2 launch'; sudo pkill -9 -f 'ros2 run'; sleep 2; sudo rm -rf /dev/shm/*; ros2 daemon stop 2>/dev/null; sleep 1; echo 'âœ“ æœåŠ¡å·²å½»åº•åœæ­¢ï¼Œèµ„æºå·²é‡Šæ”¾'",
        "addpay": false,
        "append": "",
        "useSpawn": false,
        "timer": "10",
        "oldrc": false,
        "x": 350,
        "y": 660,
        "wires": [
            [
                "debug_stop_info"
            ],
            [],
            []
        ]
    },
    {
        "id": "debug_stop_info",
        "type": "debug",
        "z": "vlm_tab",
        "name": "åœæ­¢çŠ¶æ€",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 550,
        "y": 660,
        "wires": []
    },
    {
        "id": "function_prepare_image_display",
        "type": "function",
        "z": "vlm_tab",
        "name": "å‡†å¤‡å›¾ç‰‡æ˜¾ç¤º",
        "func": "// å¤„ç†æ‹ç…§èŠ‚ç‚¹è¾“å‡ºï¼Œå‡†å¤‡æ˜¾ç¤ºå›¾ç‰‡\n// rdk-camera takephotoèŠ‚ç‚¹å¯èƒ½è¾“å‡ºï¼š\n// 1. Bufferæ ¼å¼çš„å›¾ç‰‡æ•°æ®ï¼ˆç›´æ¥å¯ç”¨ï¼‰\n// 2. å­—ç¬¦ä¸²æ ¼å¼çš„æ–‡ä»¶è·¯å¾„ï¼ˆéœ€è¦è¯»å–æ–‡ä»¶ï¼‰\n\n// å¦‚æœpayloadæ˜¯Bufferï¼Œç›´æ¥è¿”å›åˆ°image viewerï¼ˆè¾“å‡º1ï¼‰\nif (Buffer.isBuffer(msg.payload)) {\n    node.status({ fill: 'green', shape: 'dot', text: 'å›¾ç‰‡Bufferå·²å°±ç»ª' });\n    return [null, msg]; // ç¬¬ä¸€ä¸ªè¾“å‡ºä¸ºnullï¼ˆä¸è¯»å–æ–‡ä»¶ï¼‰ï¼Œç¬¬äºŒä¸ªè¾“å‡ºåˆ°image viewer\n}\n\n// å¦‚æœpayloadæ˜¯å­—ç¬¦ä¸²è·¯å¾„ï¼Œéœ€è¦è¯»å–æ–‡ä»¶ï¼ˆè¾“å‡º0ï¼‰\nif (typeof msg.payload === 'string') {\n    let imagePath = msg.payload.trim();\n    \n    // å¤„ç†è·¯å¾„ï¼šæ”¯æŒ~å¼€å¤´çš„è·¯å¾„\n    if (imagePath.startsWith('~')) {\n        imagePath = imagePath.replace(/^~/, '/home/sunrise');\n    }\n    \n    // å¦‚æœä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œæ·»åŠ é»˜è®¤ç›®å½•\n    if (!imagePath.startsWith('/')) {\n        imagePath = '/home/sunrise/vlm_model/' + imagePath;\n    }\n    \n    // è®¾ç½®filenameå±æ€§ï¼Œä¾›file inèŠ‚ç‚¹ä½¿ç”¨\n    msg.filename = imagePath;\n    node.status({ fill: 'blue', shape: 'dot', text: 'å‡†å¤‡è¯»å–å›¾ç‰‡: ' + path.basename(imagePath) });\n    return [msg, null]; // ç¬¬ä¸€ä¸ªè¾“å‡ºåˆ°file_read_photoï¼Œç¬¬äºŒä¸ªè¾“å‡ºä¸ºnull\n}\n\n// å¦‚æœéƒ½ä¸æ˜¯ï¼Œè¿”å›nullï¼ˆä¸æ˜¾ç¤ºï¼‰\nnode.status({ fill: 'yellow', shape: 'dot', text: 'æ— æ³•è¯†åˆ«å›¾ç‰‡æ ¼å¼' });\nreturn [null, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "path",
                "module": "path"
            }
        ],
        "x": 550,
        "y": 340,
        "wires": [
            [
                "file_read_photo"
            ],
            [
                "image_viewer_photo"
            ]
        ]
    },
    {
        "id": "file_read_photo",
        "type": "file in",
        "z": "vlm_tab",
        "name": "è¯»å–å›¾ç‰‡æ–‡ä»¶",
        "filename": "",
        "format": "buffer",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 750,
        "y": 340,
        "wires": [
            [
                "image_viewer_photo"
            ]
        ]
    },
    {
        "id": "image_viewer_photo",
        "type": "image viewer",
        "z": "vlm_tab",
        "name": "æ˜¾ç¤ºæ‹æ‘„çš„å›¾ç‰‡",
        "width": "640",
        "data": "payload",
        "dataType": "msg",
        "active": true,
        "x": 950,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "global_config_vlm",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-rdk-camera": "0.0.17"
        }
    }
]