[
    {
        "id": "mobilenet_unet_tab",
        "type": "tab",
        "label": "MobileNet_UNet è¯­ä¹‰åˆ†å‰²",
        "disabled": false,
        "info": "# MobileNet_UNet è¯­ä¹‰åˆ†å‰²\n\n## åŠŸèƒ½ä»‹ç»\n\nMobileNet_UNetè¯­ä¹‰åˆ†å‰²ç®—æ³•ï¼Œæ”¯æŒUSBæ‘„åƒå¤´æ‹ç…§ã€USBè§†é¢‘æµå’ŒMIPIè§†é¢‘æµä¸‰ç§æ¨¡å¼ã€‚\n\n## ä½¿ç”¨æµç¨‹\n\n### æ¨¡å¼1ï¼šUSBæ‹ç…§åˆ†å‰²\n1. **æ‹ç…§**ï¼šç‚¹å‡»\"ğŸ“· USBæ‘„åƒå¤´æ‹ç…§\"æŒ‰é’®\n2. **è‡ªåŠ¨åˆ†å‰²**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¯¹ç…§ç‰‡è¿›è¡ŒMobileNet_UNetåˆ†å‰²\n3. **æŸ¥çœ‹ç»“æœ**ï¼šåˆ†å‰²ç»“æœä¼šç›´æ¥æ˜¾ç¤ºåœ¨Node-REDç¼–è¾‘å™¨ä¸­\n\n### æ¨¡å¼2ï¼šUSBè§†é¢‘æµåˆ†å‰²ï¼ˆå®æ—¶ï¼‰\n1. **å¯åŠ¨è§†é¢‘æµ**ï¼šç‚¹å‡»\"ğŸ¥ USBæ‘„åƒå¤´è§†é¢‘æµ\"æŒ‰é’®\n2. **æŸ¥çœ‹å¯è§†åŒ–**ï¼šç‚¹å‡»\"æ‰“å¼€å¯è§†åŒ–é¡µé¢\"åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å®æ—¶åˆ†å‰²ç»“æœ\n3. **åœæ­¢æœåŠ¡**ï¼šå®Œæˆåç‚¹å‡»\"åœæ­¢æ‰€æœ‰æœåŠ¡\"\n\n### æ¨¡å¼3ï¼šMIPIè§†é¢‘æµåˆ†å‰²ï¼ˆå®æ—¶ï¼‰\n1. **å¯åŠ¨è§†é¢‘æµ**ï¼šç‚¹å‡»\"ğŸ“¹ MIPIæ‘„åƒå¤´è§†é¢‘æµ\"æŒ‰é’®\n2. **æŸ¥çœ‹å¯è§†åŒ–**ï¼šç‚¹å‡»\"æ‰“å¼€å¯è§†åŒ–é¡µé¢\"åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å®æ—¶åˆ†å‰²ç»“æœ\n3. **åœæ­¢æœåŠ¡**ï¼šå®Œæˆåç‚¹å‡»\"åœæ­¢æ‰€æœ‰æœåŠ¡\"\n\n## æ”¯æŒå¹³å°\n\n- RDK X5\n- RDK S100\n- RDK X3\n\n## æ ¸å¿ƒé€šä¿¡é…ç½®\n\n### WebSocketè§†é¢‘æµ\n- **è§†é¢‘æµåœ°å€**: `http://{host}:8000`\n- **å›¾åƒTopic**: `/image` (JPEGç¼–ç çš„å›¾åƒæµ)\n- **æ€§èƒ½**: å®æ—¶æ£€æµ‹ï¼Œå»¶è¿Ÿä½\n\n## æ³¨æ„äº‹é¡¹\n\n- æ‹ç…§æ¨¡å¼çš„åˆ†å‰²ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ° `/tmp/mobilenet_unet/` ç›®å½•\n- è§†é¢‘æµæ¨¡å¼éœ€è¦å…ˆå¯åŠ¨è§†é¢‘æµï¼Œå†æ‰“å¼€å¯è§†åŒ–é¡µé¢\n- åˆ†å‰²è¿‡ç¨‹éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
        "env": []
    },
    {
        "id": "global_config_mobilenet_unet",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-rdk-camera": "0.0.17",
            "node-red-contrib-image-tools": "2.1.1"
        }
    },
    {
        "id": "comment_photo_section",
        "type": "comment",
        "z": "mobilenet_unet_tab",
        "name": "ğŸ“· æ‹ç…§åˆ†å‰²æµç¨‹",
        "info": "ç‚¹å‡»æ‹ç…§æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œåˆ†å‰²å¹¶æ˜¾ç¤ºç»“æœ",
        "x": 150,
        "y": 40,
        "wires": []
    },
    {
        "id": "inject_take_photo",
        "type": "inject",
        "z": "mobilenet_unet_tab",
        "name": "ğŸ“· USBæ‘„åƒå¤´æ‹ç…§",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 100,
        "wires": [
            [
                "rdk_camera_take_photo"
            ]
        ]
    },
    {
        "id": "rdk_camera_take_photo",
        "type": "rdk-camera takephoto",
        "z": "mobilenet_unet_tab",
        "cameratype": "1",
        "filemode": "2",
        "filename": "photo.jpg",
        "filedefpath": "0",
        "filepath": "/tmp/mobilenet_unet",
        "fileformat": "jpeg",
        "resolution": "2",
        "rotation": "0",
        "fliph": "0",
        "flipv": "0",
        "brightness": "50",
        "contrast": "0",
        "sharpness": "0",
        "quality": "80",
        "imageeffect": "none",
        "exposuremode": "auto",
        "iso": "0",
        "agcwait": "1.0",
        "led": "0",
        "awb": "auto",
        "name": "æ‹ç…§",
        "x": 350,
        "y": 100,
        "wires": [
            [
                "debug_camera_output",
                "function_prepare_segmentation"
            ]
        ]
    },
    {
        "id": "debug_camera_output",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "è°ƒè¯•ï¼šæ‹ç…§èŠ‚ç‚¹è¾“å‡º",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 550,
        "y": 60,
        "wires": []
    },
    {
        "id": "debug_prepare_seg",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "è°ƒè¯•ï¼šå‡†å¤‡åˆ†å‰²",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 750,
        "y": 60,
        "wires": []
    },
    {
        "id": "function_prepare_segmentation",
        "type": "function",
        "z": "mobilenet_unet_tab",
        "name": "å‡†å¤‡åˆ†å‰²",
        "func": "// ç¡®ä¿ç›®å½•å­˜åœ¨å¹¶è·å–ç…§ç‰‡è·¯å¾„\n// fs å’Œ path å·²åœ¨ libs ä¸­å£°æ˜ï¼Œç›´æ¥ä½¿ç”¨\nconst saveDir = '/tmp/mobilenet_unet';\n\n// ç¡®ä¿ç›®å½•å­˜åœ¨\nif (!fs.existsSync(saveDir)) {\n    fs.mkdirSync(saveDir, { recursive: true });\n}\n\n// rdk-camera takephotoèŠ‚ç‚¹ä¼šåœ¨msg.payloadä¸­è¿”å›å®é™…ä¿å­˜çš„æ–‡ä»¶è·¯å¾„\n// ä¾‹å¦‚: \"/tmp/mobilenet_unet/image-20251121-154610.jpg\"\nlet photoPath = null;\nlet photoFileName = null;\n\n// ä¼˜å…ˆä½¿ç”¨msg.payloadä¸­çš„æ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²ï¼‰\nif (msg.payload && typeof msg.payload === 'string' && msg.payload.trim()) {\n    photoPath = msg.payload.trim();\n    \n    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n    if (fs.existsSync(photoPath)) {\n        photoFileName = path.basename(photoPath);\n        node.status({ fill: 'green', shape: 'dot', text: 'ç…§ç‰‡: ' + photoFileName });\n        \n        // æ–‡ä»¶å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨\n        msg.photoPath = photoPath;\n        msg.photoFileName = photoFileName;\n        msg.photoDir = saveDir;\n        \n        return msg;\n    } else {\n        // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸€ä¸‹ï¼ˆæœ€å¤š2.5ç§’ï¼‰\n        const self = node;\n        let retryCount = 0;\n        const maxRetries = 5;\n        \n        const checkFile = function() {\n            if (fs.existsSync(photoPath)) {\n                const newMsg = {\n                    photoPath: photoPath,\n                    photoFileName: path.basename(photoPath),\n                    photoDir: saveDir\n                };\n                self.status({ fill: 'green', shape: 'dot', text: 'ç…§ç‰‡å·²æ‰¾åˆ°' });\n                self.send(newMsg);\n            } else if (retryCount < maxRetries) {\n                retryCount++;\n                setTimeout(checkFile, 500);\n            } else {\n                self.error('ç…§ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ' + photoPath);\n                self.status({ fill: 'red', shape: 'dot', text: 'ç…§ç‰‡ä¸å­˜åœ¨' });\n            }\n        };\n        \n        setTimeout(checkFile, 500);\n        return null;\n    }\n} else if (msg.payload && Buffer.isBuffer(msg.payload)) {\n    // å¦‚æœpayloadæ˜¯Bufferï¼Œä¿å­˜åˆ°æŒ‡å®šç›®å½•\n    photoFileName = 'photo.jpg';\n    photoPath = path.join(saveDir, photoFileName);\n    try {\n        fs.writeFileSync(photoPath, msg.payload);\n        node.status({ fill: 'green', shape: 'dot', text: 'ç…§ç‰‡å·²ä¿å­˜' });\n        \n        msg.photoPath = photoPath;\n        msg.photoFileName = photoFileName;\n        msg.photoDir = saveDir;\n        \n        return msg;\n    } catch (err) {\n        node.error('ä¿å­˜ç…§ç‰‡å¤±è´¥: ' + err.message);\n        return null;\n    }\n} else {\n    // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤è·¯å¾„\n    photoFileName = 'photo.jpg';\n    photoPath = path.join(saveDir, photoFileName);\n    if (!fs.existsSync(photoPath)) {\n        node.error('æ— æ³•æ‰¾åˆ°ç…§ç‰‡æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ‹ç…§èŠ‚ç‚¹é…ç½®');\n        node.status({ fill: 'red', shape: 'dot', text: 'ç…§ç‰‡ä¸å­˜åœ¨' });\n        return null;\n    }\n    node.status({ fill: 'green', shape: 'dot', text: 'ä½¿ç”¨é»˜è®¤è·¯å¾„' });\n    \n    msg.photoPath = photoPath;\n    msg.photoFileName = photoFileName;\n    msg.photoDir = saveDir;\n    \n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "path",
                "module": "path"
            }
        ],
        "x": 550,
        "y": 100,
        "wires": [
            [
                "debug_prepare_seg",
                "function_build_seg_command"
            ]
        ]
    },
    {
        "id": "function_build_seg_command",
        "type": "function",
        "z": "mobilenet_unet_tab",
        "name": "æ„å»ºåˆ†å‰²å‘½ä»¤",
        "func": "// æ„å»ºåˆ†å‰²å‘½ä»¤\n// æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼šæœ¬åœ°å›¾ç‰‡å›çŒä½¿ç”¨ dnn_node_example_feedback.launch.py\n// å®˜æ–¹ç¤ºä¾‹ï¼šros2 launch dnn_node_example dnn_node_example_feedback.launch.py dnn_example_config_file:=config/mobilenet_unet_workconfig.json dnn_example_image:=config/test.jpg\n// æ³¨æ„ï¼šdnn_example_image å‚æ•°æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„è·¯å¾„\n// æ¸²æŸ“ç»“æœä¿å­˜åœ¨è¿è¡Œè·¯å¾„ä¸‹ï¼Œå‘½åæ ¼å¼ï¼šrender_frameid_æ—¶é—´æˆ³ç§’_æ—¶é—´æˆ³çº³ç§’.jpg\nconst photoDir = msg.photoDir || '/tmp/mobilenet_unet';\nconst photoFileName = msg.photoFileName || 'photo.jpg';\n\n// ç¡®ä¿å›¾ç‰‡æ–‡ä»¶åœ¨å·¥ä½œç›®å½•ä¸‹ï¼ˆå¦‚æœä¸åœ¨ï¼Œéœ€è¦å¤åˆ¶ï¼‰\n// æ„å»ºå®Œæ•´çš„launchå‘½ä»¤\n// å·¥ä½œç›®å½•è®¾ç½®ä¸º photoDirï¼Œå›¾ç‰‡æ–‡ä»¶åº”è¯¥åœ¨ photoDir ä¸‹\nconst pwdCmd = 'pwd';\nmsg.payload = 'cd ' + photoDir + ' && source /opt/tros/humble/setup.bash && cp -r /opt/tros/humble/lib/dnn_node_example/config/ . 2>/dev/null || true && echo \"=== å¼€å§‹MobileNet_UNetåˆ†å‰² ===\" && echo \"å·¥ä½œç›®å½•: $(pwd)\" && echo \"å›¾ç‰‡æ–‡ä»¶: ' + photoFileName + '\" && echo \"æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å­˜åœ¨...\" && ls -lh ' + photoFileName + ' 2>&1 && echo \"å¯åŠ¨åˆ†å‰²...\" && ros2 launch dnn_node_example dnn_node_example_feedback.launch.py dnn_example_config_file:=config/mobilenet_unet_workconfig.json dnn_example_image:=' + photoFileName + ' dnn_example_dump_render_img:=1';\n\nnode.status({ fill: 'blue', shape: 'dot', text: 'å‘½ä»¤å·²æ„å»º' });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 100,
        "wires": [
            [
                "debug_build_command",
                "exec_start_segmentation"
            ]
        ]
    },
    {
        "id": "debug_build_command",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "è°ƒè¯•ï¼šæ„å»ºçš„å‘½ä»¤",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 950,
        "y": 60,
        "wires": []
    },
    {
        "id": "exec_start_segmentation",
        "type": "exec",
        "z": "mobilenet_unet_tab",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": true,
        "timer": "0",
        "oldrc": false,
        "name": "å¯åŠ¨åˆ†å‰²",
        "x": 950,
        "y": 100,
        "wires": [
            [
                "debug_seg_output",
                "function_wait_and_refresh"
            ],
            [
                "debug_seg_error"
            ],
            []
        ]
    },
    {
        "id": "debug_seg_output",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "åˆ†å‰²è¾“å‡º",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1180,
        "y": 80,
        "wires": []
    },
    {
        "id": "debug_seg_error",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "åˆ†å‰²é”™è¯¯",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 1180,
        "y": 120,
        "wires": []
    },
    {
        "id": "inject_refresh_display",
        "type": "inject",
        "z": "mobilenet_unet_tab",
        "name": "åˆ·æ–°æ˜¾ç¤º",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "x": 110,
        "y": 240,
        "wires": [
            [
                "exec_find_latest"
            ]
        ]
    },
    {
        "id": "exec_find_latest",
        "type": "exec",
        "z": "mobilenet_unet_tab",
        "command": "cd /tmp/mobilenet_unet && ls -t render_*.jpg render_*.jpeg 2>/dev/null | head -1",
        "addpay": false,
        "append": "",
        "useSpawn": false,
        "timer": "",
        "oldrc": false,
        "name": "æŸ¥æ‰¾æœ€æ–°ç»“æœ",
        "x": 320,
        "y": 240,
        "wires": [
            [
                "function_check_file"
            ],
            [],
            []
        ]
    },
    {
        "id": "exec_list_dir",
        "type": "exec",
        "z": "mobilenet_unet_tab",
        "command": "cd /tmp/mobilenet_unet && echo \"å½“å‰ç›®å½•: $(pwd)\" && echo \"ç›®å½•å†…å®¹:\" && ls -lh 2>&1",
        "addpay": false,
        "append": "",
        "useSpawn": false,
        "timer": "",
        "oldrc": false,
        "name": "åˆ—å‡ºç›®å½•å†…å®¹ï¼ˆè°ƒè¯•ï¼‰",
        "x": 320,
        "y": 280,
        "wires": [
            [
                "debug_find_result"
            ],
            [],
            []
        ]
    },
    {
        "id": "debug_find_result",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "è°ƒè¯•ï¼šæŸ¥æ‰¾ç»“æœ",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 520,
        "y": 260,
        "wires": []
    },
    {
        "id": "function_check_file",
        "type": "function",
        "z": "mobilenet_unet_tab",
        "name": "æ£€æŸ¥æ–‡ä»¶è·¯å¾„",
        "func": "// æå–æ–‡ä»¶è·¯å¾„ï¼ˆexecèŠ‚ç‚¹è¾“å‡ºå¯èƒ½åŒ…å«æ¢è¡Œç¬¦ï¼‰\nvar output = msg.payload ? msg.payload.toString().trim() : '';\n\n// å¦‚æœè¾“å‡ºä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶\nif (!output) {\n    node.status({ fill: 'yellow', shape: 'dot', text: 'æœªæ‰¾åˆ°æ–‡ä»¶' });\n    return null;\n}\n\n// æå–ç¬¬ä¸€è¡Œï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰\nvar lines = output.split('\\n').filter(line => line.trim().length > 0);\nvar filename = lines.length > 0 ? lines[0].trim() : '';\n\n// å¦‚æœæ–‡ä»¶åä¸æ˜¯å®Œæ•´è·¯å¾„ï¼Œæ·»åŠ ç›®å½•å‰ç¼€\nif (filename && !filename.startsWith('/')) {\n    filename = '/tmp/mobilenet_unet/' + filename;\n}\n\nif (!filename) {\n    node.warn('æ— æ³•æå–æ–‡ä»¶è·¯å¾„');\n    node.status({ fill: 'red', shape: 'dot', text: 'è·¯å¾„æå–å¤±è´¥' });\n    return null;\n}\n\nmsg.filename = filename;\nnode.status({ fill: 'green', shape: 'dot', text: 'æ‰¾åˆ°æ–‡ä»¶: ' + path.basename(filename) });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "path",
                "module": "path"
            }
        ],
        "x": 520,
        "y": 240,
        "wires": [
            [
                "debug_file_path",
                "file_read_image"
            ]
        ]
    },
    {
        "id": "debug_file_path",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "è°ƒè¯•ï¼šæ–‡ä»¶è·¯å¾„",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 720,
        "y": 260,
        "wires": []
    },
    {
        "id": "file_read_image",
        "type": "file in",
        "z": "mobilenet_unet_tab",
        "name": "è¯»å–å›¾ç‰‡",
        "filename": "",
        "format": "buffer",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 720,
        "y": 240,
        "wires": [
            [
                "image_viewer_result"
            ]
        ]
    },
    {
        "id": "image_viewer_result",
        "type": "image viewer",
        "z": "mobilenet_unet_tab",
        "name": "æ˜¾ç¤ºåˆ†å‰²ç»“æœ",
        "width": "640",
        "data": "payload",
        "dataType": "msg",
        "active": true,
        "x": 920,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "comment_control_section",
        "type": "comment",
        "z": "mobilenet_unet_tab",
        "name": "ğŸ® æ§åˆ¶åŠŸèƒ½",
        "info": "åœæ­¢åˆ†å‰²æœåŠ¡",
        "x": 120,
        "y": 320,
        "wires": []
    },
    {
        "id": "inject_stop",
        "type": "inject",
        "z": "mobilenet_unet_tab",
        "name": "åœæ­¢æœåŠ¡",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "stop",
        "payloadType": "str",
        "x": 100,
        "y": 380,
        "wires": [
            [
                "exec_stop_all"
            ]
        ]
    },
    {
        "id": "exec_stop_all",
        "type": "exec",
        "z": "mobilenet_unet_tab",
        "command": "sudo pkill -2 -f ros; sleep 3;",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "10",
        "winHide": false,
        "oldrc": false,
        "name": "åœæ­¢æœåŠ¡",
        "x": 320,
        "y": 380,
        "wires": [
            [
                "debug_stop_info"
            ],
            [],
            []
        ]
    },
    {
        "id": "debug_stop_info",
        "type": "debug",
        "z": "mobilenet_unet_tab",
        "name": "åœæ­¢çŠ¶æ€",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 520,
        "y": 380,
        "wires": []
    },
    {
        "id": "function_wait_and_refresh",
        "type": "function",
        "z": "mobilenet_unet_tab",
        "name": "ç­‰å¾…åˆ†å‰²å®Œæˆ",
        "func": "// è½®è¯¢æ£€æŸ¥åˆ†å‰²ç»“æœæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ\n// æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼šæ¸²æŸ“ç»“æœä¿å­˜åœ¨è¿è¡Œè·¯å¾„ä¸‹ï¼Œå‘½åæ–¹å¼ä¸º render_frameid_æ—¶é—´æˆ³ç§’_æ—¶é—´æˆ³çº³ç§’.jpg\n// fs å’Œ path å·²åœ¨ libs ä¸­å£°æ˜ï¼Œç›´æ¥ä½¿ç”¨\nconst saveDir = '/tmp/mobilenet_unet';\n\n// ä½¿ç”¨å…¨å±€å˜é‡æ¥é¿å…é‡å¤è§¦å‘å’Œå¤„ç†\nif (typeof global.refreshScheduled === 'undefined') {\n    global.refreshScheduled = false;\n}\nif (typeof global.processedFiles === 'undefined') {\n    global.processedFiles = new Set();\n}\n\nif (!global.refreshScheduled) {\n    global.refreshScheduled = true;\n    \n    // è½®è¯¢æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæœ€å¤šç­‰å¾…20ç§’ï¼ˆåˆ†å‰²éœ€è¦æ—¶é—´ï¼‰\n    let checkCount = 0;\n    const maxChecks = 40; // 40æ¬¡ Ã— 500ms = 20ç§’\n    const self = node;\n    let timerId = null;\n    \n    const checkFile = function() {\n        checkCount++;\n        \n        // æŸ¥æ‰¾æœ€æ–°çš„renderæ–‡ä»¶ï¼ˆå‘½åæ ¼å¼ï¼šrender_frameid_æ—¶é—´æˆ³ç§’_æ—¶é—´æˆ³çº³ç§’.jpgï¼‰\n        try {\n            if (!fs.existsSync(saveDir)) {\n                self.warn('ç›®å½•ä¸å­˜åœ¨: ' + saveDir);\n                if (checkCount < maxChecks) {\n                    timerId = setTimeout(checkFile, 500);\n                } else {\n                    global.refreshScheduled = false;\n                    self.status({ fill: 'red', shape: 'dot', text: 'ç›®å½•ä¸å­˜åœ¨' });\n                }\n                return;\n            }\n            \n            const files = fs.readdirSync(saveDir).filter(f => \n                f.startsWith('render_') && (f.endsWith('.jpg') || f.endsWith('.jpeg') || f.endsWith('.JPG') || f.endsWith('.JPEG'))\n            );\n            \n            if (files.length > 0) {\n                // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œå–æœ€æ–°çš„\n                files.sort((a, b) => {\n                    const statA = fs.statSync(path.join(saveDir, a));\n                    const statB = fs.statSync(path.join(saveDir, b));\n                    return statB.mtime - statA.mtime;\n                });\n                \n                const latestFile = files[0];\n                const filePath = path.join(saveDir, latestFile);\n                const fileStat = fs.statSync(filePath);\n                \n                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨æœ€è¿‘10ç§’å†…è¢«ä¿®æ”¹ï¼ˆè¯´æ˜åˆšç”Ÿæˆï¼‰\n                const now = Date.now();\n                const fileTime = fileStat.mtime.getTime();\n                const timeDiff = (now - fileTime) / 1000; // ç§’\n                \n                // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªæ–‡ä»¶\n                if (global.processedFiles.has(filePath)) {\n                    // æ–‡ä»¶å·²å¤„ç†ï¼Œåœæ­¢è½®è¯¢\n                    if (timerId) clearTimeout(timerId);\n                    global.refreshScheduled = false;\n                    self.status({ fill: 'green', shape: 'dot', text: 'ç»“æœå·²æ˜¾ç¤º' });\n                    return;\n                }\n                \n                if (timeDiff < 10) {\n                    // æ–‡ä»¶åˆšç”Ÿæˆä¸”æœªå¤„ç†è¿‡ï¼Œæ ‡è®°ä¸ºå·²å¤„ç†å¹¶å‘é€\n                    global.processedFiles.add(filePath);\n                    if (timerId) clearTimeout(timerId);\n                    global.refreshScheduled = false;\n                    self.status({ fill: 'green', shape: 'dot', text: 'ç»“æœå·²ç”Ÿæˆ: ' + latestFile });\n                    self.send({filename: filePath});\n                    return;\n                } else {\n                    // æ–‡ä»¶å¤ªæ—§ï¼Œç»§ç»­æ£€æŸ¥\n                    self.status({ fill: 'blue', shape: 'dot', text: 'ç­‰å¾…æ–°æ–‡ä»¶... (' + checkCount + '/' + maxChecks + ')' });\n                }\n            } else {\n                self.status({ fill: 'yellow', shape: 'dot', text: 'æ£€æŸ¥ä¸­... (' + checkCount + '/' + maxChecks + ')' });\n            }\n        } catch (err) {\n            // ç›®å½•ä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥ï¼Œç»§ç»­ç­‰å¾…\n            self.warn('æ£€æŸ¥æ–‡ä»¶å¤±è´¥: ' + err.message);\n        }\n        \n        if (checkCount < maxChecks) {\n            // ç»§ç»­æ£€æŸ¥\n            timerId = setTimeout(checkFile, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡\n        } else {\n            // è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢\n            global.refreshScheduled = false;\n            self.status({ fill: 'yellow', shape: 'dot', text: 'è¶…æ—¶ï¼Œæœªæ‰¾åˆ°æ–°ç»“æœ' });\n        }\n    };\n    \n    // å»¶è¿Ÿ3ç§’åå¼€å§‹æ£€æŸ¥ï¼ˆç»™åˆ†å‰²ä¸€äº›å¯åŠ¨æ—¶é—´ï¼‰\n    timerId = setTimeout(checkFile, 3000);\n}\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "path",
                "module": "path"
            }
        ],
        "x": 1180,
        "y": 100,
        "wires": [
            [
                "debug_file_path",
                "file_read_image"
            ]
        ]
    }
]